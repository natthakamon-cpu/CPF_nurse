<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    * { box-sizing: border-box; }

    .header { font-size: 16px; }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    .container { font-size: 24px; }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i { font-size: 26px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* ===== ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å ===== */
    .box {
      position: relative;
      background: #fff;
      padding: 40px;
      border-radius: 14px;
      max-width: 1500px;
      margin: 40px auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, .25);
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
    .top-bar {
      text-align: left;
      margin-bottom: 10px;
    }

    .back-menu-btn {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      font-size: 20px;
      border-radius: 8px;
      text-decoration: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: 0.2s;
    }

    .back-menu-btn:hover { background: #218838; }

    h2 {
      text-align: center;
      font-size: 32px;
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .search {
      width: 100%;
      padding: 14px;
      font-size: 22px;
      margin-bottom: 20px;
      border: 1px solid #bbb;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      vertical-align: middle;
    }

    th { background: #90CAF9; }

    .action-btn {
      cursor: pointer;
      font-size: 22px;
      margin: 0 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: none;
      background: transparent;
      user-select: none;
    }

    .action-btn:hover { opacity: .75; }

    .action-btn.disabled {
      pointer-events: none;
      opacity: .55;
    }

    .action-btn.danger { filter: saturate(1.2); }

    .page { display: none; }
    .page.active { display: block; }

    tr.removing {
      opacity: .45;
      filter: grayscale(1);
    }

    /* Toast */
    .toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      z-index: 9999;
      background: #333;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 18px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .25);
      max-width: min(520px, calc(100vw - 48px));
    }

    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #1b7f3a; }
    .toast.error { background: #b3261e; }
    .toast.info { background: #2a2a2a; }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <!-- ================= LIST ================= -->
    <div id="page-list" class="box page active">
      <div class="top-bar">
        <a href="/medical_certificate" class="back-menu-btn">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
      </div>

      <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</h2>

      <input id="searchInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" onkeyup="filterTable(this.value)">
      <table id="recordTable"></table>
    </div>

    <!-- ================= VIEW ================= -->
    <div id="page-view" class="box page">
      <div class="top-bar">
        <a href="#" class="back-menu-btn" onclick="back(); return false;">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
      </div>

      <h2>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</h2>
      <div id="viewBox"></div>
    </div>
  </div>

  <div class="footer">
    ¬© 2026 Safety Officer, CPF Khon Kaen Feedmill
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ================= CONFIG ================= */
    const PART2_FIELDS = {
      doctor_name: "‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå",
      hospital_name: "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à",
      weight: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å",
      height: "‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á",
      bp: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô",
      pulse: "‡∏ä‡∏µ‡∏û‡∏à‡∏£",
      body_status: "‡∏™‡∏†‡∏≤‡∏û‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå",
      body_detail: "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå",
      work_result: "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"
    };

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å server
    const initialRecords = {{ records | tojson | safe }};
    let allRecords = Array.isArray(initialRecords) ? [...initialRecords] : [];
    let currentQuery = "";
    const deletingIds = new Set();

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ route ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå
    const DELETE_ENDPOINTS = [
      { method: "DELETE", url: (id) => `/api/medical_certificate/delete/${encodeURIComponent(id)}`, expectsJson: true },
      { method: "POST",   url: (id) => `/medical_certificate/delete/${encodeURIComponent(id)}`,     expectsJson: true },
      { method: "GET",    url: (id) => `/medical_certificate/delete/${encodeURIComponent(id)}`,     expectsJson: false }
    ];

    /* ================= UTIL ================= */
    function safe(v) {
      return (v === null || v === undefined || v === "") ? "-" : String(v);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showToast(msg, type = "info", ms = 1400) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.className = `toast ${type}`;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => el.classList.remove("show"), ms);
    }

    function openPage(p) {
      document.querySelectorAll(".page").forEach(x => x.classList.remove("active"));
      document.getElementById("page-" + p).classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function back() { openPage("list"); }

    function getFilteredRecords() {
      if (!currentQuery) return allRecords;
      return allRecords.filter(r =>
        (r.fullname || "").toLowerCase().includes(currentQuery) ||
        String(r.requester_date || r.created_at || "").toLowerCase().includes(currentQuery)
      );
    }

    function renumberVisibleRows() {
      const rows = document.querySelectorAll("#recordTable tr[data-id]");
      rows.forEach((tr, idx) => {
        const no = tr.querySelector(".col-no");
        if (no) no.textContent = String(idx + 1);
      });
    }

    function ensureEmptyRow() {
      const table = document.getElementById("recordTable");
      const hasData = table.querySelector("tr[data-id]");
      const hasEmpty = table.querySelector("tr.row-empty");
      if (!hasData && !hasEmpty) {
        table.insertAdjacentHTML("beforeend", `
          <tr class="row-empty">
            <td colspan="4" style="color:#777;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        `);
      }
      if (hasData && hasEmpty) hasEmpty.remove();
    }

    /* ================= TABLE ================= */
    function renderTable(list = allRecords) {
      let html = `
        <tr>
          <th>#</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      `;

      if (!list.length) {
        html += `
          <tr class="row-empty">
            <td colspan="4" style="color:#777;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        `;
        document.getElementById("recordTable").innerHTML = html;
        return;
      }

      for (let i = 0; i < list.length; i++) {
        const r = list[i];
        const id = r.id;
        html += `
          <tr data-id="${escapeHtml(id)}">
            <td class="col-no">${i + 1}</td>
            <td>${escapeHtml(safe(r.fullname))}</td>
            <td>${escapeHtml(safe(r.requester_date || r.created_at))}</td>
            <td>
              <button class="action-btn js-action" data-action="view" data-id="${escapeHtml(id)}" title="‡∏î‡∏π">üëÅÔ∏è</button>
              <button class="action-btn js-action" data-action="print" data-id="${escapeHtml(id)}" title="‡∏û‡∏¥‡∏°‡∏û‡πå">üñ®Ô∏è</button>
              <button class="action-btn js-action" data-action="edit" data-id="${escapeHtml(id)}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button class="action-btn danger js-action" data-action="delete" data-id="${escapeHtml(id)}" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }

      document.getElementById("recordTable").innerHTML = html;
    }

    function filterTable(q) {
      currentQuery = (q || "").trim().toLowerCase();
      renderTable(getFilteredRecords());
    }

    /* ================= VIEW / EDIT / PRINT ================= */
    function viewRecord(id) {
      const r = allRecords.find(x => String(x.id) === String(id));
      if (!r) return;

      let html = `
        <h3>üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</h3>
        <table>
          <tr><td>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</td><td>${escapeHtml(safe(r.title))}</td></tr>
          <tr><td>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</td><td>${escapeHtml(safe(r.fullname))}</td></tr>
          <tr><td>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</td><td>${escapeHtml(safe(r.address))}</td></tr>
          <tr><td>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</td><td>${escapeHtml(safe(r.disease))} ${escapeHtml(safe(r.disease_detail === "-" ? "" : r.disease_detail || ""))}</td></tr>
          <tr><td>‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</td><td>${escapeHtml(safe(r.accident))} ${escapeHtml(safe(r.accident_detail === "-" ? "" : r.accident_detail || ""))}</td></tr>
          <tr><td>‡πÄ‡∏Ñ‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</td><td>${escapeHtml(safe(r.hospital))} ${escapeHtml(safe(r.hospital_detail === "-" ? "" : r.hospital_detail || ""))}</td></tr>
          <tr><td>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</td><td>${escapeHtml(safe(r.other_history))}</td></tr>
          <tr><td>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</td><td>${escapeHtml(safe(r.requester_sign))}</td></tr>
          <tr><td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</td><td>${escapeHtml(safe(r.requester_date))}</td></tr>
        </table>

        <h3>üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå</h3>
        <table>
      `;

      Object.entries(PART2_FIELDS).forEach(([k, label]) => {
        html += `<tr><td>${escapeHtml(label)}</td><td>${escapeHtml(safe(r[k]))}</td></tr>`;
      });

      html += `</table>`;

      document.getElementById("viewBox").innerHTML = html;
      openPage("view");
    }

    function editRecord(id) {
      window.location.href = `/medical_certificate/edit/${encodeURIComponent(id)}`;
    }

    function printRecord(id) {
      window.open(`/medical_certificate/print/${encodeURIComponent(id)}`, "_blank");
    }

    /* ================= DELETE (FAST) ================= */
    async function attemptDeleteOnServer(id) {
      for (const ep of DELETE_ENDPOINTS) {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 12000);

          const res = await fetch(ep.url(id), {
            method: ep.method,
            headers: { "Accept": "application/json" },
            cache: "no-store",
            keepalive: true,
            signal: controller.signal
          });

          clearTimeout(timeout);

          if (!res.ok) continue;

          if (ep.expectsJson) {
            const data = await res.json().catch(() => ({ success: true }));
            if (typeof data.success !== "undefined" && !data.success) continue;
          }

          return true; // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        } catch (_) {
          // ‡∏•‡∏≠‡∏á endpoint ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        }
      }
      throw new Error("delete failed on all endpoints");
    }

    async function deleteRecord(id, rowEl) {
      if (deletingIds.has(id)) return;
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;

      deletingIds.add(id);

      const backupAll = allRecords.slice();
      const row = rowEl;
      const parent = row ? row.parentNode : null;
      const nextEl = row ? row.nextElementSibling : null;
      const rowHTML = row ? row.outerHTML : null;

      // Optimistic UI: ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (row) {
        row.classList.add("removing");
        row.querySelectorAll(".js-action").forEach(b => b.classList.add("disabled"));
        const delBtn = row.querySelector('[data-action="delete"]');
        if (delBtn) delBtn.textContent = "‚è≥";
        row.remove();
      }

      allRecords = allRecords.filter(r => String(r.id) !== String(id));
      renumberVisibleRows();
      ensureEmptyRow();
      showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...", "info", 900);

      try {
        await attemptDeleteOnServer(id);
        showToast("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "success", 1400);
      } catch (err) {
        console.error(err);

        // rollback state
        allRecords = backupAll;

        // rollback DOM
        if (parent && rowHTML) {
          const empty = document.querySelector("#recordTable .row-empty");
          if (empty) empty.remove();

          if (nextEl) nextEl.insertAdjacentHTML("beforebegin", rowHTML);
          else parent.insertAdjacentHTML("beforeend", rowHTML);

          renumberVisibleRows();
          ensureEmptyRow();
        } else {
          renderTable(getFilteredRecords());
        }

        showToast("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß)", "error", 2200);
      } finally {
        deletingIds.delete(id);
      }
    }

    /* ================= INIT ================= */
    document.addEventListener("DOMContentLoaded", () => {
      renderTable(allRecords);

      document.getElementById("recordTable").addEventListener("click", (e) => {
        const btn = e.target.closest(".js-action");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;

        if (action === "view") return viewRecord(id);
        if (action === "print") return printRecord(id);
        if (action === "edit") return editRecord(id);
        if (action === "delete") return deleteRecord(id, btn.closest("tr"));
      });
    });
  </script>
</body>
</html>
