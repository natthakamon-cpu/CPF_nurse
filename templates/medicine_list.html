<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>{{ group }}</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    *{ box-sizing:border-box; }
    body{ font-family:'Sarabun',sans-serif; background:#f4f6f8; margin:0; }
    .header{ width:100%; background:#fff; border-bottom:1px solid #e0e0e0; padding:14px 40px; display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; color:#5b2c83; }
    .header-left i{ font-size:26px; }
    .header-right{ display:flex; align-items:center; gap:16px; font-size:14px; }
    .logout-btn{ background:#ff6b6b; color:#fff; padding:8px 16px; border-radius:6px; text-decoration:none; font-weight:600; }

    .container{
      max-width:1500px; background:#fff; margin:40px auto; padding:40px;
      border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.25);
      position:relative;
    }

    .top-bar{ text-align:left; margin-bottom:10px; }

    .back-menu-btn{
      display:inline-block;
      background:#28a745;
      color:white;
      padding:10px 20px;
      font-size:20px;
      border-radius:8px;
      text-decoration:none;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      transition:0.2s;
    }
    .back-menu-btn:hover{ background:#218838; }

    /* ปุ่มเพิ่ม (เหมือนหน้าเวชภัณฑ์) */
    .add-btn{
      position:absolute;
      top:15px;
      right:15px;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color:#fff;
      border:none;
      padding:16px 22px;
      font-size:18px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 10px 22px rgba(137, 137, 137, 0.35);
      display:flex;
      align-items:center;
      gap:10px;
      transition:0.2s;
    }
    .add-btn i{ font-size:20px; }
    .add-btn:hover{ transform: translateY(-2px); filter:brightness(0.98); }
    .add-btn:active{ transform: translateY(0px); }

    .title{ text-align:center; font-size:32px; font-weight:700; margin:10px 0 30px; }

    .grid{
      display:flex; flex-wrap:wrap; gap:22px;
      justify-content:flex-start;
      padding:10px 0 0;
    }

    .med-card{ position:relative; width:360px; }

    .med-box{
      width:100%;
      height:120px;
      background: linear-gradient(135deg, #1E88E5 0%, #90CAF9 100%);
      border-radius:16px; text-decoration:none; color:#0b2b4a;
      display:flex; align-items:center; justify-content:center;
      font-size:26px; font-weight:800;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
      transition:all .2s ease;
      text-align:center;
      padding:0 18px;
    }
    .med-box:hover{ transform:translateY(-3px); box-shadow:0 10px 25px rgba(0,0,0,0.25); }

    .del-form{ position:absolute; top:10px; right:10px; margin:0; }
    .del-btn{
      width:42px; height:42px; border:none; border-radius:12px; cursor:pointer;
      background:rgba(255,255,255,0.85);
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      display:flex; align-items:center; justify-content:center;
      font-size:16px; color:#d12b2b;
    }
    .del-btn:hover{ background:#fff; transform:scale(1.05); }

    /* ===== Modal (เหมือน supply_list) ===== */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .modal.show{ display:flex; }

    .modal-card{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
      padding:22px;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .modal-head h3{ margin:0; font-size:20px; }

    .close-btn{
      border:none;
      background:#f1f1f1;
      width:36px;
      height:36px;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
    }
    .close-btn:hover{ filter:brightness(0.95); }

    .form-row{ margin-top:12px; }
    .form-row label{
      display:block;
      font-size:14px;
      font-weight:700;
      margin-bottom:6px;
      color:#333;
    }
    .form-row input{
      width:100%;
      padding:12px 14px;
      border:1px solid #d9d9d9;
      border-radius:10px;
      font-size:16px;
      outline:none;
      font-family:'Sarabun',sans-serif;
    }
    .form-row input:focus{ border-color:#3b82f6; }

    .form-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:16px;
    }
    .btn{
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      font-family:'Sarabun',sans-serif;
    }
    .btn-cancel{ background:#e5e7eb; }
    .btn-save{ background:#3b82f6; color:#fff; }

    .footer{ width:100%; background:#dcdcdc; text-align:center; padding:18px; font-size:14px; color:#555; margin-top:60px; }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ห้องพยาบาล CPF ขอนแก่น
    </div>
    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | หน่วยงาน Safety
      <a href="/logout" class="logout-btn">ออก</a>
    </div>
  </div>

  <div class="container">
    <div class="top-bar">
      <a href="/medicine/group" class="back-menu-btn">⬅ ย้อนกลับ</a>
    </div>

    {% if (session.get('role','')|lower) in ['admin','user'] %}
    <button type="button" class="add-btn" id="openAdd">
      <i class="fa-solid fa-plus"></i> เพิ่มชื่อยา/เวชภัณฑ์
    </button>
    {% endif %}

    <div class="title">{{ group }}</div>

    <div class="grid">
      {% for m in meds %}
        <div class="med-card">
          <a class="med-box" href="/medicine/{{ m.id }}">{{ m.name }}</a>

          {% if (session.get("role","")|lower) in ["admin","user"] %}
          <form class="del-form" method="post" action="/medicine/{{ m.id }}/delete"
                onsubmit="return confirm('ยืนยันลบ: {{ m.name }} ?\n(ระบบจะลบ LOT ของรายการนี้ด้วย)');">
            <button type="submit" class="del-btn" title="ลบรายการ">
              <i class="fa-solid fa-trash"></i>
            </button>
          </form>
          {% endif %}

        </div>
      {% endfor %}
    </div>

    {% if not meds %}
      <p style="color:#999; margin-top:20px;">ยังไม่มีรายการในกลุ่มนี้</p>
    {% endif %}
  </div>

  <!-- Modal เพิ่มยา/เวชภัณฑ์ -->
  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>เพิ่มชื่อยา/เวชภัณฑ์ (กลุ่ม: {{ group }})</h3>
        <button type="button" class="close-btn" id="closeAdd" aria-label="close">✕</button>
      </div>

      <form method="post" action="/medicine/add">
        <input type="hidden" name="group" value="{{ group }}">

        <div class="form-row">
          <label>ชื่อยา/เวชภัณฑ์</label>
          <input type="text" name="name" id="medName" required>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" id="cancelAdd">ยกเลิก</button>
          <button type="submit" class="btn btn-save">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <div class="footer">
    © 2025 Safety Officer, CPF Khon Kaen Feedmill
  </div>

  <script>
    const openBtn = document.getElementById("openAdd");
    const modal = document.getElementById("addModal");
    const closeBtn = document.getElementById("closeAdd");
    const cancelBtn = document.getElementById("cancelAdd");

    function openModal(){
      if(!modal) return;
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
      const input = document.getElementById("medName");
      if(input) input.focus();
    }

    function closeModal(){
      if(!modal) return;
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
    }

    if(openBtn) openBtn.addEventListener("click", openModal);
    if(closeBtn) closeBtn.addEventListener("click", closeModal);
    if(cancelBtn) cancelBtn.addEventListener("click", closeModal);

    if(modal){
      modal.addEventListener("click", (e) => {
        if(e.target === modal) closeModal();
      });
    }

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeModal();
    });
  </script>
</body>
</html>
