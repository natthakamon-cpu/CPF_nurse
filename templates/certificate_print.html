<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Medical_Certificate</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Sarabun", sans-serif;
        font-size: 12pt;
        line-height: 1.78;
        background: white;
        padding: 0;
      }

      @page {
        size: A4;
        margin: 3mm 5mm;
      }

      .certificate-container {
        width: 100%;
        border: 2px solid #000;
        padding: 11px;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 12pt;
      }

      .cert-title {
        text-align: center;
        font-size: 17pt;
        font-weight: 700;
        margin: 5px 0 7px;
      }

      .section-header {
        font-weight: 700;
        font-size: 13pt;
        margin: 10px 0 5px;
        display: inline-block;
        background: #000;
        color: #fff;
        padding: 1px 8px;
      }

      .info-line {
        margin-bottom: 3px;
        line-height: 1.78;
        font-size: 12pt;
      }

      .underline {
        display: inline-block;
        padding: 0 3px;
      }

      .underline.has-underline {
        border-bottom: 1px dotted #000;
        min-width: 100px;
      }

      .id-boxes {
        display: inline-flex;
        gap: 3px;
        margin: 0 3px;
        align-items: center;
      }

      .id-box {
        width: 19px;
        height: 24px;
        border: 1px solid #000;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11pt;
        font-weight: 700;
      }

      .id-separator {
        display: inline-block;
        margin: 0 1px;
      }

      .checkbox {
        width: 12px;
        height: 12px;
        border: 1px solid #000;
        display: inline-block;
        margin: 0 2px;
        vertical-align: middle;
        position: relative;
      }

      .checkbox.checked::before {
        content: "✓";
        font-size: 10pt;
        font-weight: 700;
        position: absolute;
        left: 0;
        top: -3px;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 3px 0;
      }

      .health-item {
        margin-bottom: 3px;
        font-size: 12pt;
      }

      .signature-area {
        text-align: right;
        margin-top: 4px;
        font-size: 12pt;
      }

      .note-section {
        margin-top: 5px;
        font-size: 10pt;
        line-height: 1.3;
      }

      .note-title {
        font-weight: 700;
        margin-bottom: 1px;
      }

      .long-text {
        text-indent: 2em;
        margin: 4px 0;
        line-height: 1.38;
        font-size: 11pt;
      }

      .disease-list {
        margin-left: 2em;
        line-height: 1.38;
        font-size: 11pt;
      }

      .disease-list div {
        margin-bottom: 2px;
      }

      @media print {
        body {
          padding: 0;
          zoom: 0.87;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
          color-adjust: exact;
        }

        .no-print {
          display: none !important;
        }

        @page {
          size: A4 portrait;
          margin: 3mm 5mm;
        }

        .certificate-container {
          page-break-inside: avoid;
        }

        .section-header {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
          color-adjust: exact;
        }
      }

      .action-buttons {
        text-align: center;
        margin: 12px 0;
      }

      .btn {
        padding: 8px 20px;
        font-size: 13pt;
        font-weight: 600;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 0 5px;
      }

      .btn-print {
        background: #1e88e5;
        color: white;
      }

      .btn-back {
        background: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="certificate-container">
      <!-- ปุ่ม (ซ่อนตอนพิมพ์) -->
      <div class="action-buttons no-print">
        <a href="/medical_certificate" class="btn btn-back">⬅ ย้อนกลับ</a>
        <button class="btn btn-print" onclick="window.print()">🖨️ พิมพ์</button>
      </div>

      <!-- หัว -->
      <div class="header-row">
        <div>
          เลขที่
          <span class="underline" style="min-width: 100px" id="cert-number-left"
            >__________</span
          >
        </div>
        <div>
          เลขที่
          <span
            class="underline"
            style="min-width: 100px"
            id="cert-number-right"
            >__________</span
          >
        </div>
      </div>

      <div class="cert-title">ใบรับรองแพทย์</div>

      <!-- ส่วนที่ 1 -->
      <div style="margin-bottom: 6px">
        <div style="margin-bottom: 3px">
          <span class="section-header">ส่วนที่ 1</span>
          <span style="font-weight: 600; font-size: 12pt; margin-left: 8px"
            >ของผู้ขอรับใบรับรองสุขภาพ</span
          >
        </div>
        <div style="margin-top: 3px">
          <div class="info-line">
            <span>ข้าพเจ้า </span>
            <span
              class="underline"
              style="min-width: 250px; font-weight: 700"
              id="fullname"
              >พงศ์ภรณ์ สีทอง</span
            >
          </div>

          <div class="info-line">
            <span>ที่อยู่ </span>
            <span class="underline" style="min-width: 520px" id="address"
              >บ.7 หมู่ 7 ต.ชนบท อ.วาปีปทุม จ.มหาสารคาม</span
            >
          </div>

          <div class="info-line">
            <span>สถานที่อยู่ (ที่สามารถติดต่อได้) </span>
            <span
              class="underline"
              style="min-width: 400px"
              id="contact-address"
              >บ.7 หมู่ 7 ต.ชนบท อ.วาปีปทุม จ.มหาสารคาม</span
            >
          </div>

          <div class="info-line" style="text-align: center; margin: 6px 0">
            <span>หมายเลขบัตรประจำตัวประชาชน</span>
            <div class="id-boxes">
              <div class="id-box" id="id-1">1</div>
              <span class="id-separator">-</span>
              <div class="id-box" id="id-2">1</div>
              <div class="id-box" id="id-3">0</div>
              <div class="id-box" id="id-4">0</div>
              <div class="id-box" id="id-5">7</div>
              <span class="id-separator">-</span>
              <div class="id-box" id="id-6">0</div>
              <div class="id-box" id="id-7">3</div>
              <div class="id-box" id="id-8">5</div>
              <div class="id-box" id="id-9">5</div>
              <div class="id-box" id="id-10">3</div>
              <span class="id-separator">-</span>
              <div class="id-box" id="id-11">4</div>
              <div class="id-box" id="id-12">6</div>
              <span class="id-separator">-</span>
              <div class="id-box" id="id-13">9</div>
            </div>
          </div>

          <div class="info-line">
            <span>ข้าพเจ้าขอรับใบรับรองสุขภาพ โดยมีประวัติสุขภาพดังนี้</span>
          </div>

          <div class="two-col">
            <div>
              <div class="health-item">
                <div>1. โรคประจำตัว</div>
                <div style="margin-left: 12px">
                  <span class="checkbox" id="disease-no"></span> ไม่มี
                  <span class="checkbox" id="disease-yes"></span> มี (ระบุ)
                  <span
                    class="underline"
                    style="min-width: 100px"
                    id="disease-detail"
                    >ภูมิแพ้</span
                  >
                </div>
              </div>

              <div class="health-item">
                <div>2. อุบัติเหตุ และ ผ่าตัด</div>
                <div style="margin-left: 12px">
                  <span class="checkbox" id="accident-no"></span> ไม่มี
                  <span class="checkbox" id="accident-yes"></span> มี (ระบุ)
                  <span
                    class="underline"
                    style="min-width: 100px"
                    id="accident-detail"
                    >_______</span
                  >
                </div>
              </div>
            </div>

            <div>
              <div class="health-item">
                <div>3. เคยเข้ารับการรักษาในโรงพยาบาล</div>
                <div style="margin-left: 12px">
                  <span class="checkbox" id="hospital-no"></span> ไม่มี
                  <span class="checkbox" id="hospital-yes"></span> มี (ระบุ)
                  <span
                    class="underline"
                    style="min-width: 90px"
                    id="hospital-detail"
                    >_______</span
                  >
                </div>
              </div>

              <div class="health-item">
                <div>4. ประวัติอื่นที่</div>
                <div style="margin-left: 12px">
                  <span>สำคัญ </span
                  ><span
                    class="underline"
                    style="min-width: 60px"
                    id="other-history"
                    >_______</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="signature-area">
            <div style="margin-top: 3px">
              <span>ลงชื่อ </span>
              <span
                class="underline"
                style="min-width: 60px"
                id="requester-sign"
                >ทัศนะเกศ</span
              >
              <span> วันที่ </span>
              <span class="underline" style="min-width: 20px" id="req-day"
                >20</span
              >
              <span> เดือน </span>
              <span class="underline" style="min-width: 50px" id="req-month"
                >มกราคม</span
              >
              <span> พ.ศ. </span>
              <span class="underline" style="min-width: 35px" id="req-year"
                >2569</span
              >
            </div>
            <div style="font-size: 10pt; margin-top: 1px">
              ในกรณีนี้เป็นสิทธิในสาธารณสุขหลักฐาน
              ให้ปฏิบัติครอบครัวฉบับจริงสมบูรณ์
            </div>
          </div>
        </div>
      </div>

      <!-- ส่วนที่ 2 -->
      <div style="margin-bottom: 6px">
        <div style="margin-bottom: 3px">
          <span class="section-header">ส่วนที่ 2</span>
          <span style="font-weight: 600; font-size: 12pt; margin-left: 8px"
            >ของแพทย์</span
          >
        </div>
        <div style="margin-top: 3px">
          <div class="info-line">
            <span>สถานที่ตรวจ </span>
            <span class="underline" style="min-width: 200px" id="hospital-name"
              >_________________</span
            >
            <span style="margin-left: 15px">วันที่ </span>
            <span class="underline" style="min-width: 30px" id="exam-day"
              >___</span
            >
            <span> เดือน </span>
            <span class="underline" style="min-width: 60px" id="exam-month"
              >________</span
            >
            <span> พ.ศ. </span>
            <span class="underline" style="min-width: 40px" id="exam-year"
              >____</span
            >
          </div>

          <div class="info-line">
            <span>(1) ข้าพเจ้า นายแพทย์/แพทย์หญิง </span>
            <span class="underline" style="min-width: 250px" id="doctor-name"
              >_________________________</span
            >
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>ใบอนุญาตประกอบ</span>
            <span class="underline" style="min-width: 150px"
              >_______________</span
            >
            <span>สถาน</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>วิชาชีพเวชกรรมเลขที่ </span>
            <span class="underline" style="min-width: 120px" id="license"
              >____________</span
            >
            <span>พยาบาลชื่อ</span>
          </div>

          <div class="info-line">
            <span>ที่อยู่ </span>
            <span
              class="underline"
              style="min-width: 500px"
              id="hospital-address"
              >__________________________________________________</span
            >
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>ได้ตรวจร่างกายนาย/นาง/นางสาว </span>
            <span class="underline" style="min-width: 250px" id="patient-name"
              >_________________________</span
            >
          </div>

          <div class="info-line">
            <span>แล้วเห็นว่า </span>
            <span class="underline" style="min-width: 30px">___</span>
            <span> เดือน </span>
            <span class="underline" style="min-width: 70px">________</span>
            <span> พ.ศ. </span>
            <span class="underline" style="min-width: 45px">____</span>
            <span> มีราย</span>
          </div>

          <div class="info-line">
            <span>ละเอียดดังนี้</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>น้ำ </span>
            <span class="underline" style="min-width: 40px" id="weight"
              >____</span
            >
            <span> กก. ความสูง </span>
            <span class="underline" style="min-width: 40px" id="height"
              >____</span
            >
            <span> เซนติเมตร ความดันโลหิต </span>
            <span class="underline" style="min-width: 60px" id="bp"
              >______</span
            >
            <span> มม.ปรอท ชีพจร </span>
            <span class="underline" style="min-width: 40px" id="pulse"
              >____</span
            >
            <span> ครั้ง</span>
          </div>

          <div class="info-line">
            <span>หนัก </span>
            <span class="underline" style="min-width: 70px">ความสูง</span>
            <span> ความดัน </span>
            <span class="underline" style="min-width: 80px">ความดันโลหิต</span>
            <span> ชีพจร </span>
            <span class="underline" style="min-width: 60px">____</span>
            <span> นาที</span>
          </div>

          <div class="info-line">
            <span>ที่ลักษณ</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>สภาพร่างกายที่ไม่อยู่ในเกณฑ์ </span>
            <span class="checkbox" id="body-normal"></span> ปกติ
            <span class="checkbox" id="body-abnormal"></span> ผิดปกติ (ระบุ)
          </div>

          <div class="long-text">
            ขอรับรองว่า บุคคลดังกล่าว
            ไม่เป็นผู้มีร่างกายทุพพลภาพจนไม่สามารถปฏิบัติหน้าที่ได้ไม่ปรากฏอาการของโรคจิต
            หรือจิตฟั่นเฟือน หรือปัญญาอ่อน ไม่ปรากฏอาการของการติดยาเสพติดให้โทษ
            และอาการของโรคพิษสุราเรื้อรัง
            และไม่ปรากฏอาการและอาการแสดงของโรคต่อไปนี้
          </div>

          <div class="disease-list">
            <div>
              (1) โรคเรื้อนในระยะติดต่อ
              หรือในระยะที่ปรากฏอาการเป็นที่รังเกียจแก่สังคม
            </div>
            <div>(2) วัณโรคในระยะอันตราย</div>
            <div>(3) โรคเท้าช้างในระยะที่ปรากฏอาการเป็นที่รังเกียจแก่สังคม</div>
            <div>
              (4) อื่น ๆ (ถ้ามี)
              <span
                class="underline"
                style="min-width: 200px"
                id="other-disease"
                >____________________</span
              >
              (โรคที่ใส่ในวงเล็บนี้ใช้กรรณาพิเจตนารมณ์มายืดยาว)
            </div>
          </div>

          <div class="info-line">
            <span>(2) สรุปความเห็นและชื่อและเวชระเบียนแพทย์ </span>
            <span class="checkbox" id="work-ok"></span>
            สามารถทำงานในที่สีบอากาศได้
            <span class="checkbox" id="work-not-ok"></span>
            ไม่สามารถทำงานที่สีบอากาศได้
          </div>

          <div class="signature-area" style="margin-top: 8px">
            <div>
              <span>ลงชื่อ </span>
              <span class="underline" style="min-width: 100px" id="doctor-sign"
                >__________________</span
              >
            </div>
            <div style="margin-top: 1px">แพทย์ผู้ตรวจร่างกาย</div>
          </div>

          <div class="note-section">
            <div class="note-title">หมายเหตุ</div>
            <div>
              (1)
              ต้องเป็นแพทย์ซึ่งได้รับขึ้นทะเบียนรับใบอนุญาตประกอบวิชาชีพเวชกรรม
            </div>
            <div>
              (2) ให้แสดงว่าเป็นผู้มีร่างกายสมบูรณ์เพียงใด
              ใบรับรองแพทย์ฉบับนี้ให้ใช้ได้ 1 เดือนนับแต่วันที่ตรวจร่างกาย +
              เลขนัดครั้งต่อไป 4/2561 วันที่ 19 เมษายน 2561
            </div>
            <div>(3) คำรับรองนี้เป็นการตรวจวินิจฉัยเบื้องต้น</div>
            <div>
              แบบฟอร์มนี้ได้รับการรับรองจากมติคณะกรรมการแพทยสภาในการประชุมครั้งที่
              4/2561 วันที่ 19 เมษายน 2561
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function convertToBuddhistYear(dateString) {
        if (!dateString) return { day: "", month: "", year: "" };
        const date = new Date(dateString);
        const months = [
          "มกราคม",
          "กุมภาพันธ์",
          "มีนาคม",
          "เมษายน",
          "พฤษภาคม",
          "มิถุนายน",
          "กรกฎาคม",
          "สิงหาคม",
          "กันยายน",
          "ตุลาคม",
          "พฤศจิกายน",
          "ธันวาคม",
        ];
        return {
          day: date.getDate().toString(),
          month: months[date.getMonth()],
          year: (date.getFullYear() + 543).toString(),
        };
      }

      function fillCitizenId(citizenId) {
        if (!citizenId) return;
        const digits = citizenId.replace(/[^0-9]/g, "").split("");
        for (let i = 1; i <= 13 && i <= digits.length; i++) {
          const box = document.getElementById(`id-${i}`);
          if (box) box.textContent = digits[i - 1] || "_";
        }
      }

      function checkBox(id) {
        const box = document.getElementById(id);
        if (box) box.classList.add("checked");
      }

      function loadData() {
        const urlParams = new URLSearchParams(window.location.search);
        const certId = urlParams.get("id");

        if (certId) {
          fetch(`/api/medical_certificate/${certId}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                populateForm(data.record);
              }
            })
            .catch((err) => console.error("Error:", err));
        } else {
          const tempData = localStorage.getItem("tempCertificateData");
          if (tempData) {
            populateForm(JSON.parse(tempData));
            localStorage.removeItem("tempCertificateData");
          }
        }
      }

      function setFieldValue(id, value, defaultBlank = "") {
        const el = document.getElementById(id);
        if (!el) return;

        // ถ้ามีค่าและไม่ใช่ค่าเริ่มต้นที่เป็น underscores
        if (value && !value.match(/^_+$/)) {
          el.textContent = value;
          if (el.classList.contains("underline")) {
            el.classList.remove("has-underline");
          }
        } else {
          el.textContent = defaultBlank;
          if (el.classList.contains("underline")) {
            el.classList.add("has-underline");
          }
        }
      }

      function populateForm(data) {
        setFieldValue("cert-number-left", data.cert_number);
        setFieldValue("cert-number-right", data.cert_number);
        setFieldValue("fullname", data.fullname);
        setFieldValue("address", data.address);
        setFieldValue("contact-address", data.address);

        fillCitizenId(data.citizenId);

        if (data.disease === "ไม่มี") checkBox("disease-no");
        else if (data.disease === "มี") {
          checkBox("disease-yes");
          setFieldValue("disease-detail", data.disease_detail);
        }

        if (data.accident === "ไม่มี") checkBox("accident-no");
        else if (data.accident === "มี") {
          checkBox("accident-yes");
          setFieldValue("accident-detail", data.accident_detail);
        }

        if (data.hospital === "ไม่มี") checkBox("hospital-no");
        else if (data.hospital === "มี") {
          checkBox("hospital-yes");
          setFieldValue("hospital-detail", data.hospital_detail);
        }

        setFieldValue("other-history", data.other_history);

        const reqDate = convertToBuddhistYear(data.requester_date);
        setFieldValue("req-day", reqDate.day);
        setFieldValue("req-month", reqDate.month);
        setFieldValue("req-year", reqDate.year);
        setFieldValue("requester-sign", data.requester_sign);

        setFieldValue("hospital-name", data.hospital_name);

        const examDate = convertToBuddhistYear(data.exam_date);
        setFieldValue("exam-day", examDate.day);
        setFieldValue("exam-month", examDate.month);
        setFieldValue("exam-year", examDate.year);

        setFieldValue("doctor-name", data.doctor_name);
        setFieldValue("license", data.license);
        setFieldValue("hospital-address", data.hospital_address);
        setFieldValue("patient-name", data.fullname);

        setFieldValue("weight", data.weight);
        setFieldValue("height", data.height);
        setFieldValue("bp", data.bp);
        setFieldValue("pulse", data.pulse);

        if (data.body_status === "ปกติ") checkBox("body-normal");
        else if (data.body_status === "ผิดปกติ") checkBox("body-abnormal");

        setFieldValue("other-disease", data.other_disease);

        if (data.work_result === "ได้") checkBox("work-ok");
        else if (data.work_result === "ไม่ได้") checkBox("work-not-ok");

        setFieldValue("doctor-sign", data.doctor_sign);
      }

      window.addEventListener("DOMContentLoaded", loadData);
    </script>
  </body>
</html>
