<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      font-size: 16px;
      /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏ó‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ */
    }

    h2 {
      font-size: 32px;
      /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà */
    }

    h4 {
      font-size: 20px;
    }

    .menu-item {
      font-size: 18px;
    }

    .graph-box,
    table,
    .scroll-item {
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* ================= CONTAINER ================= */
    .container {
      max-width: 1500px;
      /* ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
      background: #ffffff;
      margin: 40px auto;
      /* ‚≠ê ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ */
      padding: 40px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      position: relative;
    }

.top-bar{
  text-align:left;
  margin-bottom: 10px; /* ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ä‡∏¥‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
}

    .back-menu-btn{
      display:inline-block;
      background:#28a745;
      color:white;
      padding:10px 20px;
      font-size:20px;
      border-radius:8px;
      text-decoration:none;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      transition:0.2s;
    }

    .back-menu-btn:hover{
      background:#218838;
    }


    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    /* ================= MENU ================= */
    .top-menu {
      display: flex;
      border-bottom: 2px solid #ddd;
    }

    .menu-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .menu-item.active {
      background: #ffe5e5;
      border-bottom: 3px solid #ff5a5a;
    }

    .back-btn {
      display: none;
      cursor: pointer;
      color: #2c7be5;
      font-weight: bold;
      margin: 10px 0;
    }

    /* ================= SCROLL ================= */
    .scroll-bar {
      display: none;
      overflow-x: auto;
      white-space: nowrap;
      margin: 10px 0;
    }

    .scroll-item {
      display: inline-block;
      padding: 6px 14px;
      margin-right: 8px;
      border-radius: 20px;
      background: #eee;
      cursor: pointer;
      font-size: 14px;
    }

    .scroll-item.active {
      background: #2c7be5;
      color: #fff;
    }

    /* ================= SECTION ================= */
    .section {
      display: none;
    }

    .show {
      display: block;
    }

    .graph-box {
      margin-top: 15px;
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
    }

    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
      /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏à‡∏≤‡∏Å container */
    }

    .dashboard-row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .dashboard-left {
      flex: 2;
    }

    .dashboard-right {
      flex: 1;
    }

    html,
    body {
      width: 100%;
      overflow-x: hidden;
    }

    /* ================= TABLE STYLE ================= */
    .drug-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Sarabun', sans-serif;
      font-size: 18px;
      /* üî† ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
    }

    .drug-table th {
      background: #4da3ff;
      /* üîµ ‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡∏î */
      color: #ffffff;
      padding: 14px;
      border: 1px solid #cfd8dc;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }

    .drug-table td {
      padding: 12px;
      border: 1px solid #ddd;
      font-size: 17px;
    }

    .drug-table tr:nth-child(even) {
      background: #f9fbff;
    }

    /* ================= MONTH (SCROLL) ================= */
    .scroll-item {
      padding: 10px 22px;
      /* üóì ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
      font-size: 18px;
      /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà */
      border-radius: 24px;
    }

    .scroll-item.active {
      background: #2c7be5;
      color: #fff;
      font-weight: 600;
    }

    .back-btn {
      display: none !important;
    }

    /* ‚úÖ ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
    #monthTop5Chart {
      height: 260px !important;
    }

    #deptChart {
      height: 340px !important;
    }

    #diseaseChart {
      height: 340px !important;
    }

    /* ===== chart sizing helpers ===== */
    .chart-wrap {
      position: relative;
      width: 100%;
    }

    /* ‚úÖ Top5 ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏û‡∏≠‡∏î‡∏µ 5 ‡πÅ‡∏ó‡πà‡∏á */
    .chart-wrap-top5 {
      height: 260px;
    }

    /* ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    .chart-wrap-sm {
      height: 420px;
    }

    /* ‚úÖ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
    .chart-title {
      margin: 0 0 12px 0;
      font-size: 24px;
      font-weight: 700;
    }

        /* ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô flex "‡∏¢‡πà‡∏≠‡πÑ‡∏î‡πâ" ‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ô‡∏•‡πâ‡∏ô */
    .dashboard-left,
    .dashboard-right{
      min-width: 0;
    }

    /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ 2 ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô iPad */
    .dashboard-row{
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    /* ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î flex ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå */
    .dashboard-left{ 
      flex: 1 1 0;
    }

    /* ‡∏Å‡∏±‡∏ô canvas ‡∏•‡πâ‡∏ô */
    .chart-wrap canvas{
      max-width: 100% !important;
    }

    /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (iPad ‡∏¢‡∏±‡∏á 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ) */
    @media (max-width: 600px){
      .dashboard-row{ flex-direction: column; }
    }

    /* ================== COST SIZE FIX ================== */
    #cost .dashboard-row{
      align-items: stretch;           /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
    }

    #cost .dashboard-left,
    #cost .dashboard-right{
      flex: 1 1 0;                    /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
      min-width: 0;
    }

    #cost .graph-box{
      height: 420px;                  /* ‚úÖ ‡∏ó‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏ß‡∏≤‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
    }

    #cost .cost-chart-wrap{
      height: 100%;
    }

    #cost .cost-chart-wrap canvas{
      width: 100% !important;
      height: 100% !important;        /* ‚úÖ ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á */
    }

    /* ================== COST TEXT SPACING (‡∏û‡∏≠‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô) ================== */

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏™‡∏£‡∏∏‡∏õ) */
    #cost .dashboard-right .graph-box{
      padding: 14px;            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */
      overflow-y: auto;         /* ‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏ô‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å) */
    }

    /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô) */
    #cost .dashboard-right .graph-box h4{
      font-size: 22px;
      margin: 14px 0 8px;       /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á */
      line-height: 1.5;        /* ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    }

    /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á ‚Äú‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‚Äù ‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÉ‡∏ä‡πâ selector ‡∏ä‡πà‡∏ß‡∏¢ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ HTML) */
    #cost .dashboard-right .graph-box h4 + div{
      margin-top: 2px;
      margin-bottom: 14px;      /* ‚úÖ ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å */
    }

    /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô */
    #cost .dashboard-right .graph-box hr{
      margin: 14px 0 !important;
    }

    /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á + ‡∏Å‡∏±‡∏ô‡∏ä‡∏¥‡∏î */
    #cost #sumTotal{
      font-size: 24px !important;
      margin: 6px 0 14px !important;
      display: block;
    }

    #cost #sumDrug,
    #cost #sumSupply,
    #cost #sumOther{
      font-size: 20px !important;
      margin: 4px 0 14px !important;
      display: block;
    }


  </style>
</head>

<body>

  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>
    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <!-- ===== CONTAINER ===== -->
  <div class="container">

    <div class="top-bar">
      <a href="/menu" class="back-menu-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π</a>
    </div>
    <h2>Dashboard ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</h2>

    <!-- ===== MENU ===== -->
    <div class="top-menu">
      <div class="menu-item active" onclick="openSection('top5',this)">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤</div>
      <div class="menu-item" onclick="openSection('month',this)">‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
      <div class="menu-item" onclick="openSection('year',this)">‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div>
      <div class="menu-item" onclick="openSection('cost',this)">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
    </div>

    <div class="back-btn" id="backBtn" onclick="goBack()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
    <div class="scroll-bar" id="scrollBar"></div>

    <!-- ===== TOP5 ===== -->
    <div id="top5" class="section show">
      <div class="graph-box">
        <table class="drug-table">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
              <th>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th>
              <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
            </tr>
          </thead>
          <tbody id="drugTable"></tbody>
        </table>

      </div>
    </div>


    <div id="month" class="section">
      <div class="graph-box">
        <h4>üíä Top 5 ‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h4>
        <div class="chart-wrap chart-wrap-top5">
          <canvas id="monthTop5Chart"></canvas>
        </div>
      </div>


      <div class="graph-box">
        <div class="dashboard-row">
          <div class="dashboard-left">
            <h3 class="chart-title">üè≠ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="deptChart"></canvas>
            </div>
          </div>

          <div class="dashboard-left">
            <h3 class="chart-title">ü©∫ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="diseaseChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div id="year" class="section">

      <div class="graph-box">
        <h4>üíä Top 5 ‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h4>
        <div class="chart-wrap chart-wrap-top5">
          <canvas id="yearTop5Chart"></canvas>
        </div>
      </div>

      <div class="graph-box">
        <div class="dashboard-row">
          <div class="dashboard-left">
            <h3 class="chart-title">üè≠ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="yearDeptChart"></canvas>
            </div>
          </div>

          <div class="dashboard-left">
            <h3 class="chart-title">ü©∫ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</h3>
            <div class="chart-wrap chart-wrap-sm">
              <canvas id="yearDiseaseChart"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>


    <!-- ================== COST ================== -->
    <div id="cost" class="section">
      <div class="dashboard-row">

        <!-- ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="dashboard-right">
          <div class="graph-box" style="text-align:center;">
            <h4>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
            <div id="sumTotal" style="font-size:26px;font-weight:700;color:#d32f2f;">0 ‡∏ö‡∏≤‡∏ó</div>
            <hr style="margin:15px 0">
            <h4>üíä ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤‡∏£‡∏ß‡∏°</h4>
            <div id="sumDrug" style="font-size:22px;font-weight:700;color:#388e3c;">0 ‡∏ö‡∏≤‡∏ó</div>
            <h4>üì¶ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏£‡∏ß‡∏°</h4>
            <div id="sumSupply" style="font-size:22px;font-weight:700;color:#1976d2;">0 ‡∏ö‡∏≤‡∏ó</div>
            <h4>üß∞ ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡∏£‡∏ß‡∏°</h4>
            <div id="sumOther" style="font-size:22px;font-weight:700;color:#6a1b9a;">0 ‡∏ö‡∏≤‡∏ó</div>

          </div>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤ -->
        <div class="dashboard-left">
          <div class="graph-box">
            <div class="chart-wrap cost-chart-wrap">
              <canvas id="monthlyCostChart"></canvas>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div><!-- ‚úÖ container ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->


  <script>
    // ================= GLOBAL =================
    if (window.Chart) {
      Chart.defaults.animation = false;
      Chart.defaults.responsive = true;
    }

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

    let allItems = [];
    let costCache = null;

    let top5MonthChart = null;
    let deptChart = null;
    let diseaseChart = null;
    let yearTop5Chart = null;
    let yearDeptChart = null;
    let yearDiseaseChart = null;
    let monthlyCostChart = null;

    let monthReqToken = 0;
    let yearReqToken = 0;
    let monthAbortCtrl = null;
    let yearAbortCtrl = null;
    let drugReqToken = 0;
    let drugAbortCtrl = null;
    let masterLoadingPromise = null;

    const monthBundleCache = new Map();
    const yearBundleCache = new Map();
    const costYearCache = new Map();
    const drugTableCache = new Map(); // key -> { ts, data }
    const DRUG_TABLE_TTL_MS = 30 * 1000;

    const monthLabels = ["‡∏°.‡∏Ñ", "‡∏Å.‡∏û", "‡∏°‡∏µ.‡∏Ñ", "‡πÄ‡∏°.‡∏¢", "‡∏û.‡∏Ñ", "‡∏°‡∏¥.‡∏¢", "‡∏Å.‡∏Ñ", "‡∏™.‡∏Ñ", "‡∏Å.‡∏¢", "‡∏ï.‡∏Ñ", "‡∏û.‡∏¢", "‡∏ò.‡∏Ñ"];

    const deptMaster = [
      "‡∏≠‡∏™‡∏£", "‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
      "‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£", "‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå"
    ];

    const symptomMaster = [
      "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á", "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
      "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå", "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
    ];

    const symptomAliasToThai = {
      "respiratory": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à",
      "digestive": "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
      "muscle": "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
      "brain": "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á",
      "skin": "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
      "internal medicine": "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°",
      "urinary": "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢",
      "reproductive": "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå",
      "eye ear mouth": "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å",
      "accident": "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏",
      "supply": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
      "supplies": "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
      "other": "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
    };

    function norm(s) {
      return String(s || "").trim().toLowerCase().replace(/\s+/g, " ");
    }

    function normDeptName(s) {
      return String(s || "").trim().replace(/\./g, "").replace(/\s+/g, " ");
    }

    function toThaiSymptom(name) {
      const k = norm(name);
      return symptomAliasToThai[k] || String(name || "").trim();
    }

    function fmtBaht(n) {
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { maximumFractionDigits: 2 }) + " ‡∏ö‡∏≤‡∏ó";
    }

    async function fetchJson(url, opts = {}) {
      const res = await fetch(url, { cache: "no-store", ...opts });
      if (!res.ok) throw new Error(`HTTP ${res.status} @ ${url}`);

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (!ct.includes("application/json")) {
        // ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™ session ‡∏´‡∏•‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏ô redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login (HTML)
        const txt = await res.text();
        throw new Error(`Expected JSON but got: ${txt.slice(0, 80)}...`);
      }
      return await res.json();
    }

    // ================= MENU =================
    function openSection(name, el) {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      if (el) el.classList.add('active');

      document.querySelectorAll('.section').forEach(s => s.classList.remove('show'));
      document.getElementById(name).classList.add('show');

      document.getElementById('backBtn').style.display = name !== 'top5' ? 'block' : 'none';

      setupScroll(name);

      if (name === "top5") {
        loadDrugTable(currentMonth, currentYear);
      } else if (name === "month") {
        renderMonthTab(currentYear, currentMonth);
      } else if (name === "year") {
        renderYearTab(currentYear);
      } else if (name === "cost") {
        ensureCostReady();
      }

      resizeVisibleCharts();
    }

    function goBack() {
      document.querySelectorAll('.menu-item')[0].click();
    }

    function setupScroll(type) {
      const bar = document.getElementById("scrollBar");
      bar.innerHTML = "";

      if (type === "year") {
        bar.style.display = "none";
        return;
      }

      bar.style.display = "block";
      const activeIndex = Math.max(0, (currentMonth || 1) - 1);

      monthLabels.forEach((m, i) => {
        bar.innerHTML += `
          <span class="scroll-item ${i === activeIndex ? 'active' : ''}"
                onclick="changeMonth(${i},this)">${m}</span>`;
      });
    }

    function changeMonth(i, el) {
      document.querySelectorAll('.scroll-item').forEach(m => m.classList.remove('active'));
      if (el) el.classList.add('active');

      currentMonth = i + 1;

      if (document.getElementById("top5").classList.contains("show")) {
        loadDrugTable(currentMonth, currentYear);
      }
      if (document.getElementById("month").classList.contains("show")) {
        renderMonthTab(currentYear, currentMonth);
      }
      if (document.getElementById("cost").classList.contains("show")) {
        ensureCostReady();
      }
    }

    function resizeVisibleCharts() {
      requestAnimationFrame(() => {
        [top5MonthChart, deptChart, diseaseChart, yearTop5Chart, yearDeptChart, yearDiseaseChart, monthlyCostChart]
          .forEach(c => {
            try { if (c) c.resize(); } catch (_) {}
          });
      });
    }

    // ================= CHART HELPERS =================
    function upsertTop5(chartObj, canvasId, top5List) {
      let labels = (top5List || []).map(x => x.name);
      let values = (top5List || []).map(x => Number(x.total || 0));

      if (!labels.length) {
        labels = ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"];
        values = [0];
      }

      const data = {
        labels,
        datasets: [{
          label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢",
          data: values,
          backgroundColor: ['#9abfe3', '#9ce2c8', '#f8cfb4', '#eabbff', '#eaa3ce'],
          borderWidth: 0,
          maxBarThickness: 70,
          categoryPercentage: 0.7,
          barPercentage: 0.8
        }]
      };

      if (!chartObj) {
        return new Chart(document.getElementById(canvasId), {
          type: "bar",
          data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: { legend: { display: false }, title: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }

      chartObj.data = data;
      chartObj.update("none");
      return chartObj;
    }

    function upsertHBar(chartObj, canvasId, labels, values, bgColor, fontX = 18, fontY = 20) {
      const maxV = values.length ? Math.max(...values) : 0;
      const bar = Math.max(10, Math.min(24, Math.floor(360 / Math.max(labels.length, 1))));

      const data = {
        labels,
        datasets: [{
          data: values,
          backgroundColor: bgColor,
          barThickness: bar,
          maxBarThickness: bar
        }]
      };

      const options = {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            beginAtZero: true,
            suggestedMax: maxV > 0 ? (maxV + 1) : 1,
            ticks: { stepSize: 1, precision: 0, font: { size: fontX } }
          },
          y: { ticks: { font: { size: fontY } } }
        }
      };

      if (!chartObj) {
        return new Chart(document.getElementById(canvasId), { type: "bar", data, options });
      }

      chartObj.data = data;
      chartObj.options = options;
      chartObj.update("none");
      return chartObj;
    }

    // ================= MONTH TAB (1 API / tab) =================
    async function renderMonthTab(year, month) {
      const reqId = ++monthReqToken;
      const cacheKey = `${year}-${month}`;

      let pack = monthBundleCache.get(cacheKey);

      if (!pack) {
        try {
          if (monthAbortCtrl) monthAbortCtrl.abort();
          monthAbortCtrl = new AbortController();

          pack = await fetchJson(`/api/dashboard/month_bundle?year=${year}&month=${month}`, {
            signal: monthAbortCtrl.signal
          });

          monthBundleCache.set(cacheKey, pack);
        } catch (e) {
          if (e.name === "AbortError") return;
          console.error("‡πÇ‡∏´‡∏•‡∏î month_bundle ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
          return; // ‡πÑ‡∏°‡πà destroy ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏¥‡∏°
        }
      }

      if (reqId !== monthReqToken) return; // ‡∏Å‡∏±‡∏ô response ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö

      // top5
      top5MonthChart = upsertTop5(top5MonthChart, "monthTop5Chart", pack.top5 || []);

      // dept ‡∏Ñ‡∏£‡∏ö master
      const deptMap = {};
      (pack.dept || []).forEach(x => {
        const k = normDeptName(x.name);
        deptMap[k] = (deptMap[k] || 0) + Number(x.total || 0);
      });
      const deptLabels = deptMaster.map(normDeptName);
      const deptValues = deptMaster.map(n => Number(deptMap[normDeptName(n)] || 0));
      deptChart = upsertHBar(deptChart, "deptChart", deptLabels, deptValues, "#9abfe3", 18, 20);

      // symptom ‡∏Ñ‡∏£‡∏ö master + normalize alias
      const symMap = {};
      (pack.symptom || []).forEach(x => {
        const th = toThaiSymptom(x.name);
        symMap[th] = (symMap[th] || 0) + Number(x.total || 0);
      });
      const symLabels = symptomMaster;
      const symValues = symptomMaster.map(n => Number(symMap[n] || 0));
      diseaseChart = upsertHBar(diseaseChart, "diseaseChart", symLabels, symValues, "#9ce2c8", 18, 20);

      resizeVisibleCharts();
    }

    // ================= YEAR TAB (1 API / tab) =================
    async function renderYearTab(year) {
      const reqId = ++yearReqToken;
      const cacheKey = `${year}`;

      let pack = yearBundleCache.get(cacheKey);

      if (!pack) {
        try {
          if (yearAbortCtrl) yearAbortCtrl.abort();
          yearAbortCtrl = new AbortController();

          pack = await fetchJson(`/api/dashboard/year_bundle?year=${year}`, {
            signal: yearAbortCtrl.signal
          });

          yearBundleCache.set(cacheKey, pack);
        } catch (e) {
          if (e.name === "AbortError") return;
          console.error("‡πÇ‡∏´‡∏•‡∏î year_bundle ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
          return;
        }
      }

      if (reqId !== yearReqToken) return;

      // top5 year
      yearTop5Chart = upsertTop5(yearTop5Chart, "yearTop5Chart", pack.top5 || []);

      // dept year
      const deptMap = {};
      (pack.dept || []).forEach(x => {
        const k = normDeptName(x.name);
        deptMap[k] = (deptMap[k] || 0) + Number(x.total || 0);
      });
      const deptLabels = deptMaster.map(normDeptName);
      const deptValues = deptMaster.map(n => Number(deptMap[normDeptName(n)] || 0));
      yearDeptChart = upsertHBar(yearDeptChart, "yearDeptChart", deptLabels, deptValues, "#9abfe3", 18, 20);

      // symptom year
      const symMap = {};
      (pack.symptom || []).forEach(x => {
        const th = toThaiSymptom(x.name);
        symMap[th] = (symMap[th] || 0) + Number(x.total || 0);
      });
      const symLabels = symptomMaster;
      const symValues = symptomMaster.map(n => Number(symMap[n] || 0));
      yearDiseaseChart = upsertHBar(yearDiseaseChart, "yearDiseaseChart", symLabels, symValues, "#9ce2c8", 18, 20);

      resizeVisibleCharts();
    }

    // ================= DRUG TABLE =================
    function getDrugTableCache(key) {
      const row = drugTableCache.get(key);
      if (!row) return null;
      if (Date.now() - row.ts > DRUG_TABLE_TTL_MS) {
        drugTableCache.delete(key);
        return null;
      }
      return row.data;
    }

    function setDrugTableCache(key, data) {
      drugTableCache.set(key, { ts: Date.now(), data });
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function ensureMasterItems() {
      if (allItems.length) return allItems;
      if (masterLoadingPromise) return masterLoadingPromise;

      masterLoadingPromise = (async () => {
        try {
          const j = await fetchJson("/api/dashboard/item_master");
          allItems = (j.items || []).filter(Boolean);
          allItems.sort((a, b) => a.localeCompare(b, "th"));
        } catch (e) {
          console.error("‡πÇ‡∏´‡∏•‡∏î master items ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
          allItems = [];
        }
        return allItems;
      })();

      try {
        return await masterLoadingPromise;
      } finally {
        masterLoadingPromise = null;
      }
    }

    async function fetchDrugSummary(year, month) {
      const key = `${year}-${month}`;
      const cached = getDrugTableCache(key);
      if (cached) return cached;

      if (drugAbortCtrl) drugAbortCtrl.abort();
      drugAbortCtrl = new AbortController();

      const data = await fetchJson(`/api/dashboard/drug_summary?year=${year}&month=${month}`, {
        signal: drugAbortCtrl.signal
      });

      setDrugTableCache(key, data || {});
      return data || {};
    }

    function renderDrugTable(dataObj) {
      const tbody = document.getElementById("drugTable");
      if (!tbody) return;

      const dataNorm = {};
      Object.keys(dataObj || {}).forEach(k => {
        dataNorm[norm(k)] = dataObj[k];
      });

      const html = allItems.map(name => {
        const item = dataNorm[norm(name)] || { used: 0, remain: 0, has_used: false, has_lot: false };
        const usedVal = Number(item.used || 0);
        const usedText = (item.has_used === true || usedVal > 0) ? usedVal : "-";

        const remainText = item.has_lot ? item.remain : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";

        return `
          <tr>
            <td>${escapeHtml(name)}</td>
            <td style="text-align:center;">${escapeHtml(usedText)}</td>
            <td style="text-align:center;">${escapeHtml(remainText)}</td>
          </tr>
        `;
      }).join("");

      tbody.innerHTML = html || `<tr><td colspan="3" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    async function loadDrugTable(month = currentMonth, year = currentYear) {
      const reqId = ++drugReqToken;
      const tbody = document.getElementById("drugTable");
      if (!tbody) return;

      // optional loading (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÅ‡∏£‡∏á)
      if (!allItems.length) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
      }

      try {
        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏ô: master + summary ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        const [_, summary] = await Promise.all([
          ensureMasterItems(),
          fetchDrugSummary(year, month)
        ]);

        if (reqId !== drugReqToken) return; // ‡∏Å‡∏±‡∏ô response ‡πÄ‡∏Å‡πà‡∏≤
        renderDrugTable(summary);
      } catch (e) {
        if (e.name === "AbortError") return;
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", e);
        if (reqId === drugReqToken) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#b00020;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
        }
      }
    }


    // ================= COST =================
    async function loadCostYear(year) {
      if (costYearCache.has(year)) {
        costCache = costYearCache.get(year);
        return;
      }
      try {
        const json = await fetchJson(`/api/dashboard/monthly_cost?year=${year}`);
        const months = Array.isArray(json.months) ? json.months : [];
        costYearCache.set(year, months);
        costCache = months;
      } catch (e) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", e);
        costCache = [];
      }
    }

    function updateCostSummary(monthIndex0) {
      const m = (costCache && costCache[monthIndex0])
        ? costCache[monthIndex0]
        : { drug: 0, supply: 0, other: 0, total: 0 };

      document.getElementById("sumDrug").innerText = fmtBaht(m.drug);
      document.getElementById("sumSupply").innerText = fmtBaht(m.supply);
      document.getElementById("sumOther").innerText = fmtBaht(m.other);
      document.getElementById("sumTotal").innerText = fmtBaht(m.total);
    }

    function renderCostChart() {
      const drugData = (costCache || []).map(x => Number(x.drug || 0));
      const supplyData = (costCache || []).map(x => Number(x.supply || 0));
      const otherData = (costCache || []).map(x => Number(x.other || 0));

      const data = {
        labels: monthLabels,
        datasets: [
          { label: "‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤", data: drugData, backgroundColor: "#90CAF9" },
          { label: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå", data: supplyData, backgroundColor: "#e38cf3" },
          { label: "‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ", data: otherData, backgroundColor: "#69fff0" }
        ]
      };

      if (!monthlyCostChart) {
        monthlyCostChart = new Chart(document.getElementById("monthlyCostChart"), {
          type: "bar",
          data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: { legend: { display: true } }
          }
        });
        return;
      }

      monthlyCostChart.data = data;
      monthlyCostChart.update("none");
    }

    async function ensureCostReady() {
      await loadCostYear(currentYear);
      renderCostChart();
      updateCostSummary(currentMonth - 1);
      resizeVisibleCharts();
    }

    // ================= INIT =================
    document.addEventListener("DOMContentLoaded", async function () {
      setupScroll("top5");
      await loadDrugTable(currentMonth, currentYear);
    });

  </script>

  <div class="footer">¬© 2026 Safety Officer, CPF Khon Kaen Feedmill</div>
</body>

</html>