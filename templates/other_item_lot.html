<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>{{ item_name }}</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    *{ box-sizing:border-box; }
    body{ font-family:'Sarabun',sans-serif; background:#f4f6f8; margin:0; }
    .header{ width:100%; background:#fff; border-bottom:1px solid #e0e0e0; padding:14px 40px; display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; font-size:20px; font-weight:700; color:#5b2c83; }
    .header-left i{ font-size:26px; }
    .header-right{ display:flex; align-items:center; gap:16px; font-size:14px; }
    .logout-btn{ background:#ff6b6b; color:#fff; padding:8px 16px; border-radius:6px; text-decoration:none; font-weight:600; }

    .container{
      max-width:1500px; background:#fff; margin:40px auto; padding:40px;
      border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.25);
    }

    .top-bar{ text-align:left; margin-bottom:10px; }

    .back-menu-btn{
    display:inline-block;
    background:#28a745;
    color:white;
    padding:10px 20px;
    font-size:20px;
    border-radius:8px;
    text-decoration:none;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
    transition:0.2s;
    }

    .back-menu-btn:hover{ background:#218838; }


    .title{ text-align:center; font-size:32px; font-weight:800; margin:10px 0 26px; color:#2c3e50; }

    hr{ margin:34px 0; border:none; border-top:1px solid #ddd; }

    .section-title{
      display:inline-block;
      background: linear-gradient(135deg, #d9fbe3, #b8f2d2);
      color:#1f6f43;
      padding:10px 22px;
      border-radius:14px;
      font-size:26px;
      font-weight:700;
      margin-bottom:20px;
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
    }

    label{ font-weight:700; display:block; margin-top:14px; }
    input{
      width:100%; padding:12px; font-size:22px; margin-top:6px;
      border-radius:10px; border:1.5px solid #d6e2ec; background:#fbfdff;
    }
    input:focus{ outline:none; border-color:#7bb7e8; background:#fff; }

    button{
      font-size:22px; padding:12px 26px; border:none; border-radius:10px;
      cursor:pointer; background:#4a90e2; color:#fff; margin-top:18px; font-weight:800;
    }
    button:hover{ background:#357abd; }

    .add-lot-box{
      background: linear-gradient(135deg, #daf8ffff, #a9eeffff);
      padding:26px; border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.2);
    }

    .lot-box{
      background:#fff; border-radius:14px;
      padding:18px 22px; margin-bottom:18px;
      box-shadow:0 4px 14px rgba(0,0,0,0.15);
    }
    .lot-header{
      display:inline-block; background:#ffe066; color:#000;
      font-weight:900; padding:4px 12px; border-radius:8px; margin-bottom:12px;
    }

    .delete-btn{ background:#e74c3c; }
    .delete-btn:hover{ background:#c0392b; }

    .footer{ width:100%; background:#dcdcdc; text-align:center; padding:18px; font-size:14px; color:#555; margin-top:60px; }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>
    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <div class="top-bar">
     <a class="back-menu-btn" href="{{ back_url }}">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
    </div>

    <div class="title">{{ item_name }}</div>

    <hr>
    <div class="section-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Lot</div>

    <div class="add-lot-box">
      <form id="addLotForm" method="post" action="/other/{{ item_name | urlencode }}/add_lot">
        <label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
        <input type="date" name="expire_date">

        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
        <input type="number" name="qty" min="1" required>

        <label>‡∏£‡∏≤‡∏Ñ‡∏≤ / Lot (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" name="price" min="0.01" step="any" inputmode="decimal" required>

        <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Lot</button>
      </form>
    </div>

    <hr>
    <div class="section-title">üì¶ Lot ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</div>

    <div id="lotList">
      {% if lots %}
        {% for lot in lots %}
          <div class="lot-box" data-lot-id="{{ lot.id }}">
            <div class="lot-header">{{ lot.lot_name }}</div>
            <div>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span class="v-expire">{{ (((lot.expire_date or "").split("T")[0].split(" ")[0]) or "-") | e }}</span></div>
            <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="v-total">{{ lot.qty_total }}</span></div>
            <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="v-remain">{{ lot.qty_remain }}</span></div>
            <div>‡∏£‡∏≤‡∏Ñ‡∏≤ / Lot: <span class="v-price-lot">{{ "%.2f"|format(lot.price_per_lot) }}</span> ‡∏ö‡∏≤‡∏ó</div>
            <div>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢: <span class="v-price-unit">{{ "%.2f"|format(lot.price_per_unit) }}</span> ‡∏ö‡∏≤‡∏ó</div>

            <form method="post" action="/other_lot/{{ lot.id }}/delete" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Lot ‡∏ô‡∏µ‡πâ ?');">
              <button class="delete-btn">üóë ‡∏•‡∏ö Lot</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <p id="emptyLotText" style="color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Lot ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</p>
      {% endif %}
    </div>

  </div>

  <div class="footer">¬© 2026 Safety Officer, CPF Khon Kaen Feedmill</div>

  <script>
  (() => {
    const form = document.getElementById("addLotForm");
    const lotList = document.getElementById("lotList");
    const submitBtn = form.querySelector('button[type="submit"]');

    function to2(v){ return Number(v || 0).toFixed(2); }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function fmtExpire(v){
      const s = String(v ?? "").trim();
      if (!s) return "-";
      const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
      if (m) return m[1];
      return (s.split("T")[0].split(" ")[0] || "-");
    }

    function normalizePrice(v){
      return String(v ?? "").trim().replace(",", ".");
    }

    function isValidMoney(v){
      return /^\d+(\.\d{1,2})?$/.test(v) && Number(v) > 0;
    }

    function renderLot(lot){
      return `
        <div class="lot-box" data-lot-id="${esc(lot.id)}">
          <div class="lot-header">${esc(lot.lot_name)}</div>
          <div>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span class="v-expire">${esc(fmtExpire(lot.expire_date))}</span></div>
          <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="v-total">${esc(lot.qty_total)}</span></div>
          <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="v-remain">${esc(lot.qty_remain)}</span></div>
          <div>‡∏£‡∏≤‡∏Ñ‡∏≤ / Lot: <span class="v-price-lot">${to2(lot.price_per_lot)}</span> ‡∏ö‡∏≤‡∏ó</div>
          <div>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢: <span class="v-price-unit">${to2(lot.price_per_unit)}</span> ‡∏ö‡∏≤‡∏ó</div>
          <form method="post" action="/other_lot/${esc(lot.id)}/delete" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Lot ‡∏ô‡∏µ‡πâ ?');">
            <button class="delete-btn">üóë ‡∏•‡∏ö Lot</button>
          </form>
        </div>
      `;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const priceInput = form.querySelector('input[name="price"]');
      const normalizedPrice = normalizePrice(priceInput.value);
      if (!isValidMoney(normalizedPrice)) {
        alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡πÅ‡∏•‡∏∞‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)");
        priceInput.focus();
        return;
      }
      priceInput.value = normalizedPrice;

      submitBtn.disabled = true;
      const oldText = submitBtn.textContent;
      submitBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      try {
        const fd = new FormData(form);
        const body = new URLSearchParams(fd);

        const res = await fetch(form.action, {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest"
          },
          body
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        const lot = data.lot || {};
        const id = String(lot.id ?? "");
        const old = id ? lotList.querySelector(`.lot-box[data-lot-id="${CSS.escape(id)}"]`) : null;

        if (old) {
          old.querySelector(".v-expire").textContent = fmtExpire(lot.expire_date);
          old.querySelector(".v-total").textContent = lot.qty_total ?? 0;
          old.querySelector(".v-remain").textContent = lot.qty_remain ?? 0;
          old.querySelector(".v-price-lot").textContent = to2(lot.price_per_lot);
          old.querySelector(".v-price-unit").textContent = to2(lot.price_per_unit);
        } else {
          const empty = document.getElementById("emptyLotText");
          if (empty) empty.remove();
          lotList.insertAdjacentHTML("afterbegin", renderLot(lot));
        }

        form.reset();
      } catch (err) {
        alert(err.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = oldText;
      }
    });
  })();
  </script>

</body>
</html>
