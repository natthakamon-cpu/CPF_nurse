<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Sarabun', sans-serif;
      font-size: 24px;
      background: #f4f6f8;
      margin: 0;
    }

    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i { font-size: 26px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    .container { font-size: 24px; }

    .box {
      position: relative;
      background: #fff;
      padding: 40px;
      border-radius: 14px;
      max-width: 1500px;
      margin: 40px auto;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 20px;
    }

    .save-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #28a745;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 18px;
      font-weight: 600;
    }

    .save-btn:hover { opacity: .92; }

    h2 {
      margin-top: 10px;
      margin-bottom: 25px;
      font-size: 32px;
      font-weight: 700;
      text-align: center;
    }

    .search {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 24px;
      border-radius: 14px;
      border: 1px solid #bbb;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 14px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #cfd8dc;
      padding: 12px;
      text-align: center;
    }

    th {
      background: #90CAF9;
      color: #0d47a1;
    }

    .page { display: none; }
    .page.active { display: block; }

    .back-btn {
      margin-top: 25px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #e0e0e0;
      cursor: pointer;
      font-size: 20px;
    }

    #page-edit form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 22px 40px;
      align-items: start;
    }

    #page-edit label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    #page-edit input,
    #page-edit select,
    #page-edit textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 22px;
      border-radius: 12px;
      border: 1px solid #b0bec5;
      box-sizing: border-box;
    }

    #page-edit textarea { grid-column: 1 / -1; }
    #page-edit .medicine-group { grid-column: 1 / -1; }

    #medicine_table th {
      background: #e3f2fd;
      color: #0d47a1;
    }

    .inline {
      grid-column: 1 / -1;
      display: flex;
      gap: 40px;
      align-items: center;
      margin-top: 5px;
    }

    .inline input[type="radio"] {
      transform: scale(1.8);
      margin-right: 10px;
      cursor: pointer;
    }

    .inline label {
      font-size: 22px;
      cursor: pointer;
    }

    .edit-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .btn-save,
    .btn-cancel,
    .btn-back {
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
      color: #fff;
    }

    .btn-save { background: #2196f3; }
    .btn-cancel { background: #e53935; }
    .btn-back { background: #9e9e9e; }

    .btn-save[disabled] {
      opacity: .7;
      cursor: not-allowed;
      filter: grayscale(.12);
    }

    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }

    th.col-actions, td.col-actions {
      white-space: nowrap;
      width: 140px;
      text-align: center;
    }

    .action-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      line-height: 1;
      font-size: 20px;
    }

    .action-btn:active { transform: scale(0.96); }
    .action-btn.danger { filter: saturate(1.2); }

    .action-btn.disabled {
      pointer-events: none;
      opacity: .55;
    }

    tr.removing {
      opacity: .45;
      filter: grayscale(1);
    }

    .toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      z-index: 9999;
      background: #333;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 18px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      max-width: min(520px, calc(100vw - 48px));
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success { background: #1b7f3a; }
    .toast.error   { background: #b3261e; }
    .toast.info    { background: #2a2a2a; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
    #page-edit .medicine-group .med-row-controls {
      display: flex;
      gap: 12px;
      align-items: stretch;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    #page-edit .medicine-group .med-row-controls #medicine_select { flex: 3; min-width: 260px; }
    #page-edit .medicine-group .med-row-controls #medicine_other { flex: 3; min-width: 260px; }
    #page-edit .medicine-group .med-row-controls #lot_select { flex: 2; min-width: 220px; }
    #page-edit .medicine-group .med-row-controls #qty_input { flex: 1; min-width: 120px; }

    #page-edit .medicine-group .med-row-controls select,
    #page-edit .medicine-group .med-row-controls input[type="text"],
    #page-edit .medicine-group .med-row-controls input[type="number"] {
      min-height: 58px;
      font-size: 24px;
      border-radius: 12px;
    }

    #page-edit .medicine-group .btn-add-med {
      flex: 1.15;
      min-width: 190px;
      min-height: 58px;
      border: 1px solid #1e88e5;
      border-radius: 12px;
      background: #42a5f5;
      color: #ffffff;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(30, 136, 229, 0.25);
      transition: all .15s ease;
    }

    #page-edit .medicine-group .btn-add-med:hover { background: #1e88e5; }
    #page-edit .medicine-group .btn-add-med:active { transform: translateY(1px); }

    #page-edit #medicine_table td:last-child,
    #page-edit #medicine_table th:last-child {
      width: 120px;
    }

    #page-edit .btn-del-med {
      width: 64px;
      height: 52px;
      border: none;
      border-radius: 12px;
      background: #ef5350;
      color: #fff;
      font-size: 28px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(239, 83, 80, 0.25);
      transition: all .15s ease;
    }

    #page-edit .btn-del-med:hover { background: #e53935; }
    #page-edit .btn-del-med:active { transform: scale(0.97); }

    .small-hint {
      font-size: 16px;
      color: #546e7a;
      margin-top: -6px;
      margin-bottom: 6px;
      grid-column: 1 / -1;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>
    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <!-- LIST -->
    <div id="page-list" class="box page active">
      <div class="top-bar">
        <a href="/treatment_menu" class="save-btn">
          <i class="fa-solid fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        </a>
      </div>

      <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
      <input type="text" id="searchInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤">
      <table id="recordTable"></table>
    </div>

    <!-- VIEW -->
    <div id="page-view" class="box page">
      <div class="top-bar">
        <a href="/treatment_menu" class="save-btn">
          <i class="fa-solid fa-arrow-left"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        </a>
      </div>

      <h2>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
      <div id="viewBox"></div>
      <button class="back-btn" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>

    <!-- EDIT -->
    <div id="page-edit" class="box page">
      <div class="top-bar">
        <a href="/treatment_menu" class="save-btn">
          <i class="fa-solid fa-arrow-left"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        </a>
      </div>

      <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>

      <form id="editForm">
        <input type="hidden" id="edit_id">

        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
        <input type="datetime-local" name="visit_date" id="edit_date" step="1" required>

        <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
        <input type="text" name="patient_name" id="edit_name" required>

        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
        <select name="department" id="edit_department">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option>‡∏≠‡∏™‡∏£.</option>
          <option>‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
          <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</option>
          <option>‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</option>
          <option>‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
          <option>‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•</option>
          <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option>
          <option>‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</option>
          <option>‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
          <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
        <select name="symptom_group" id="edit_symptom_group">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value="respiratory">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</option>
          <option value="digestive">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
          <option value="muscle">‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</option>
          <option value="brain">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á</option>
          <option value="skin">‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</option>
          <option value="medicine">‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
          <option value="urinary">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢</option>
          <option value="reproductive">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
          <option value="eye">‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å</option>
          <option value="throat">‡∏Ñ‡∏≠</option>
          <option value="nose">‡∏à‡∏°‡∏π‡∏Å</option>
          <option value="wound">‡∏ó‡∏≥‡πÅ‡∏ú‡∏•</option>
          <option value="work_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</option>
          <option value="nonwork_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</option>
          <option value="supply">‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</option>
          <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
        <textarea name="symptom_detail" id="edit_symptom" rows="3"></textarea>

        <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
        <div class="medicine-group">
          <div class="med-row-controls">
            <select id="medicine_select">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
            </select>

            <input type="text" id="medicine_other" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå" style="display:none;">

            <select id="lot_select">
              <option value="">Lot</option>
            </select>

            <input type="number" id="qty_input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="1">

            <button type="button" class="btn-add-med" onclick="addMedicine()">
              <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
          </div>

          <div class="small-hint">* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>

          <table width="100%" id="medicine_table"></table>
        </div>

        <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
        <div class="inline">
          <label><input type="radio" name="allergy" value="0" checked> ‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
          <label><input type="radio" name="allergy" value="1"> ‡∏°‡∏µ</label>
        </div>

        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
        <textarea name="allergy_detail" id="edit_allergy_detail" rows="2"></textarea>

        <div style="grid-column:1 / -1; margin-top:30px;">
          <label style="font-size:26px; font-weight:700;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>

          <label style="font-weight:500; margin-top:10px;">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
          </label>

          <div class="inline">
            <label><input type="radio" name="occupational_disease" value="0" checked> ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</label>
            <label><input type="radio" name="occupational_disease" value="1"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</label>
          </div>

          <label style="margin-top:15px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
          <textarea id="edit_doctor_opinion" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå"></textarea>
        </div>

        <div class="edit-actions">
          <button type="submit" class="btn-save" id="submitEditBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button type="button" class="btn-cancel" onclick="back()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn-back" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
      </form>
    </div>
  </div>

  <div class="footer">
    ¬© 2026 Safety Officer, CPF Khon Kaen Feedmill
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===================== CONFIG =====================
    const API_TIMEOUT_MS = 20000; // ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏° UX
    const deletingIds = new Set();
    let allRecords = [];
    let editMedicines = [];

    // cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ edit ‡πÑ‡∏´‡∏•‡∏•‡∏∑‡πà‡∏ô
    const medIdCache = new Map();   // name -> medicine_id
    const lotCache = new Map();     // medicine_id -> lots[]

    const symptomLabelMap = {
      respiratory: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à",
      digestive: "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
      muscle: "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
      brain: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á",
      skin: "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
      medicine: "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°",
      urinary: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢",
      reproductive: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå",
      eye: "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å",
      throat: "‡∏Ñ‡∏≠",
      nose: "‡∏à‡∏°‡∏π‡∏Å",
      wound: "‡∏ó‡∏≥‡πÅ‡∏ú‡∏•",
      work_accident: "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô",
      nonwork_accident: "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô",
      supply: "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
      other: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
    };

    const medicineData = {
      respiratory: ['Amoxy', 'Bisolvon', 'Mybacin', 'Loratadine', 'Zyetec', 'M.tusis'],
      digestive: ['Air-x', 'K milk120cc', 'Buscopan', 'Diasgest', 'M.car', 'ORS', 'Paracetamol(500)', 'Motilium', 'K-milk', '‡∏¢‡∏≤‡∏´‡∏≠‡∏°', 'CA-R-Bon'],
      muscle: ['Balm', 'Mydoclam', 'Norgesic'],
      brain: ['B1,6,12', 'Dimen', 'ORS', 'Paracetamol(500)'],
      skin: ['Acyclovir', 'CPM', 'Loratadine', 'Zyetec', '0.1%TA Cream', 'Mycozol', 'Silver cream', 'Calamine lotion'],
      medicine: [],
      urinary: ['Paracetamol(500)', 'Norflox'],
      reproductive: ['Ponstan(500)'],
      eye: ['Hista oph', 'Op Sar', 'Ointment', 'Brufen(400)', 'Kenalog'],
      throat: [],
      nose: [],
      wound: ['Plaster', '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ'],
      work_accident: [],
      nonwork_accident: [],
      supply: [
        '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ', 'EB:3', 'EB:2', 'Mask', 'Grove Dispose', 'Eyepad',
        'Transpore', 'Sofatulle', '‡πÑ‡∏°‡πâ‡∏Å‡∏î‡∏•‡∏¥‡πâ‡∏ô', 'Gouze', 'Betadine',
        '70%Alcohol', '0.9%NSS', 'Amonia'
      ],
      other: []
    };

    // ===================== ELEMENTS =====================
    const searchInput = document.getElementById("searchInput");
    const recordTable = document.getElementById("recordTable");
    const viewBox = document.getElementById("viewBox");

    const editForm = document.getElementById("editForm");
    const submitEditBtn = document.getElementById("submitEditBtn");

    const edit_id = document.getElementById("edit_id");
    const edit_date = document.getElementById("edit_date");
    const edit_name = document.getElementById("edit_name");
    const edit_department = document.getElementById("edit_department");
    const edit_symptom_group = document.getElementById("edit_symptom_group");
    const edit_symptom = document.getElementById("edit_symptom");
    const edit_allergy_detail = document.getElementById("edit_allergy_detail");
    const edit_doctor_opinion = document.getElementById("edit_doctor_opinion");

    const medSelect = document.getElementById("medicine_select");
    const medOther = document.getElementById("medicine_other");
    const lotSelect = document.getElementById("lot_select");
    const qtyInput = document.getElementById("qty_input");

    // ===================== UTILS =====================
    function pad2(n) { return String(n).padStart(2, "0"); }

    function nowDateTimeLocal() {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    function toDateTimeLocalValue(raw) {
      if (!raw) return "";
      const s = String(raw).trim();

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return `${s}T00:00:00`;

      if (/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}(:\d{2})?$/.test(s)) {
        const t = s.replace(" ", "T");
        return t.length === 16 ? t + ":00" : t;
      }

      const d = new Date(s);
      if (isNaN(d.getTime())) return "";
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    function safeText(v) {
      return (v === null || v === undefined || v === "") ? "-" : v;
    }

    function symptomLabel(code) {
      if (!code) return "-";
      return symptomLabelMap[code] || code;
    }

    function formatMeds(medicineText) {
      if (!medicineText) return "-";
      try {
        const items = JSON.parse(medicineText);
        if (!Array.isArray(items) || items.length === 0) return "-";
        return items.map(it => {
          const name = it.name || "-";
          const lot = it.lot || "";
          const qty = it.qty || "";
          return `${name}${lot ? " " + lot : ""}${qty ? " x" + qty : ""}`;
        }).join(", ");
      } catch (_) {
        return medicineText;
      }
    }

    function showToast(msg, type = "info", ms = 1500) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.className = `toast ${type}`;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => el.classList.remove("show"), ms);
    }

    function debounce(fn, wait = 120) {
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    async function fetchJSON(url, options = {}, timeoutMs = API_TIMEOUT_MS) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch(url, {
          cache: "no-store",
          ...options,
          signal: controller.signal
        });

        let data = null;
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
          const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
          throw new Error(msg);
        }

        return data;
      } finally {
        clearTimeout(timer);
      }
    }

    function getCheckedValue(name, fallback = "0") {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : fallback;
    }

    function normalizeVisitForDisplay(v) {
      if (!v) return "-";
      return String(v).replace("T", " ");
    }

    // ===================== RENDER =====================
    function getFilteredRecordsFromInput() {
      const q = (searchInput.value || "").toLowerCase().trim();
      if (!q) return allRecords;

      return allRecords.filter(r =>
        (r.patient_name || "").toLowerCase().includes(q) ||
        (r.visit_date_display || "").toLowerCase().includes(q) ||
        (r.visit_date_raw || "").toLowerCase().includes(q) ||
        formatMeds(r.medicine).toLowerCase().includes(q)
      );
    }

    function renderTable(records) {
      let html = `
        <tr>
          <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
          <th class="col-actions">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      `;

      if (!records || records.length === 0) {
        html += `<tr><td colspan="5" style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        recordTable.innerHTML = html;
        return;
      }

      for (let i = 0; i < records.length; i++) {
        const r = records[i];
        const id = Number(r.id);
        html += `
          <tr data-id="${id}">
            <td>${i + 1}</td>
            <td>${safeText(r.visit_date_display || r.visit_date)}</td>
            <td>${safeText(r.patient_name)}</td>
            <td>${symptomLabel(r.symptom_group)}</td>
            <td class="col-actions">
              <div class="action-wrap">
                <span class="action-btn" onclick="viewRecord(${id})" title="‡∏î‡∏π">üëÅÔ∏è</span>
                <span class="action-btn" onclick="editRecord(${id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</span>
                <span class="action-btn danger" onclick="deleteRecord(${id})" title="‡∏•‡∏ö">üóëÔ∏è</span>
              </div>
            </td>
          </tr>
        `;
      }

      recordTable.innerHTML = html;
    }

    function renderMedicineTable() {
      const table = document.getElementById("medicine_table");
      table.innerHTML = `
        <tr>
          <th>‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
          <th>Lot</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
          <th>‡∏•‡∏ö</th>
        </tr>
      `;

      editMedicines.forEach((m, i) => {
        table.innerHTML += `
          <tr>
            <td>${safeText(m.name)}</td>
            <td>${safeText(m.lot)}</td>
            <td>${safeText(m.qty)}</td>
            <td>${safeText(m.price)}</td>
            <td>
              <button type="button" class="btn-del-med" onclick="removeMedicine(${i})" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
    }

    // ===================== PAGE =====================
    function switchPage(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function back() {
      switchPage("page-list");
    }

    // ===================== DATA LOAD =====================
    async function loadRecords({ silent = false } = {}) {
      try {
        const rows = await fetchJSON("/api/treatment_list");
        allRecords = Array.isArray(rows) ? rows : [];
        renderTable(getFilteredRecordsFromInput());
      } catch (err) {
        console.error(err);
        if (!silent) showToast("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error", 2200);
      }
    }

    // ===================== VIEW =====================
    async function viewRecord(id) {
      try {
        const r = await fetchJSON(`/api/treatment/${id}`);
        if (!r || !r.success) {
          showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error", 1800);
          return;
        }

        const d = r.data;
        viewBox.innerHTML = `
          <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</b> ${safeText(d.visit_date_display || d.visit_date)}</p>
          <p><b>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</b> ${safeText(d.patient_name)}</p>
          <p><b>‡πÅ‡∏ú‡∏ô‡∏Å:</b> ${safeText(d.department)}</p>
          <p><b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${symptomLabel(d.symptom_group)}</p>
          <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${safeText(d.symptom_detail)}</p>
          <p><b>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå:</b> ${formatMeds(d.medicine)}</p>
          <p><b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</b> ${String(d.allergy) === "1" ? "‡∏°‡∏µ" : "‡πÑ‡∏°‡πà‡∏°‡∏µ"}</p>
          <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</b> ${safeText(d.allergy_detail)}</p>
          <p><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b> ${String(d.occupational_disease) === "1" ? "‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢" : "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢"}</p>
          <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b> ${safeText(d.doctor_opinion)}</p>
        `;
        switchPage("page-view");
      } catch (err) {
        console.error(err);
        showToast("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error", 2200);
      }
    }

    // ===================== EDIT =====================
    async function editRecord(id) {
      try {
        const r = await fetchJSON(`/api/treatment/${id}`);
        if (!r || !r.success) {
          showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error", 1800);
          return;
        }

        const d = r.data;
        edit_id.value = d.id;
        edit_date.value = toDateTimeLocalValue(d.visit_date_input || d.visit_date_raw || d.visit_date) || nowDateTimeLocal();
        edit_name.value = d.patient_name || "";
        edit_department.value = d.department || "";
        edit_symptom_group.value = d.symptom_group || "";
        edit_symptom.value = d.symptom_detail || "";
        edit_allergy_detail.value = d.allergy_detail || "";
        edit_doctor_opinion.value = d.doctor_opinion || "";

        const occ = document.querySelector(`input[name="occupational_disease"][value="${d.occupational_disease}"]`);
        if (occ) occ.checked = true;

        const al = document.querySelector(`input[name="allergy"][value="${d.allergy}"]`);
        if (al) al.checked = true;

        editMedicines = [];
        try { editMedicines = JSON.parse(d.medicine || "[]"); } catch (_) {}
        renderMedicineTable();

        // ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô dropdown ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
        populateMedicineBySymptom(edit_symptom_group.value);

        switchPage("page-edit");
      } catch (err) {
        console.error(err);
        showToast("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error", 2200);
      }
    }

    function applyLocalEditedRecord(recordId, payloadObj) {
      const idx = allRecords.findIndex(r => Number(r.id) === Number(recordId));
      if (idx < 0) return;

      const old = allRecords[idx];
      const visitDisplay = payloadObj.visit_date
        ? normalizeVisitForDisplay(payloadObj.visit_date)
        : (old.visit_date_display || old.visit_date || "-");

      allRecords[idx] = {
        ...old,
        visit_date: visitDisplay,
        visit_date_display: visitDisplay,
        visit_date_raw: payloadObj.visit_date || old.visit_date_raw,
        patient_name: payloadObj.patient_name,
        department: payloadObj.department,
        symptom_group: payloadObj.symptom_group,
        symptom_detail: payloadObj.symptom_detail,
        medicine: payloadObj.medicine,
        allergy: payloadObj.allergy,
        allergy_detail: payloadObj.allergy_detail,
        occupational_disease: payloadObj.occupational_disease,
        doctor_opinion: payloadObj.doctor_opinion
      };
    }

    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (submitEditBtn.disabled) return;

      const id = Number(edit_id.value);
      if (!id) {
        showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "error", 1800);
        return;
      }

      const payload = {
        visit_date: edit_date.value, // datetime-local
        patient_name: edit_name.value.trim(),
        department: edit_department.value,
        symptom_group: edit_symptom_group.value,
        symptom_detail: edit_symptom.value.trim(),
        medicine: JSON.stringify(editMedicines),
        allergy: getCheckedValue("allergy", "0"),
        allergy_detail: edit_allergy_detail.value.trim(),
        occupational_disease: getCheckedValue("occupational_disease", "0"),
        doctor_opinion: edit_doctor_opinion.value.trim()
      };

      const originalBtnText = submitEditBtn.innerHTML;
      try {
        submitEditBtn.disabled = true;
        submitEditBtn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const r = await fetchJSON(`/api/treatment/edit/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }, 25000);

        if (!r || !r.success) {
          throw new Error((r && (r.message || r.error)) || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        // ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï local ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ -> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        applyLocalEditedRecord(id, payload);
        renderTable(getFilteredRecordsFromInput());
        switchPage("page-list");
        showToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success", 1400);

        // ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UX)
        setTimeout(() => loadRecords({ silent: true }), 120);
      } catch (err) {
        console.error(err);
        if (err.name === "AbortError") {
          showToast("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)", "error", 2400);
        } else {
          showToast(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${err.message || "unknown"})`, "error", 2600);
        }
      } finally {
        submitEditBtn.disabled = false;
        submitEditBtn.innerHTML = originalBtnText;
      }
    });

    // ===================== DELETE =====================
    function renumberVisibleRows() {
      const rows = document.querySelectorAll("#recordTable tr[data-id]");
      rows.forEach((tr, idx) => {
        const td0 = tr.children[0];
        if (td0) td0.textContent = String(idx + 1);
      });
    }

    async function deleteRecord(id) {
      if (deletingIds.has(id)) return;
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;

      deletingIds.add(id);

      const backupAll = allRecords.slice();
      const row = document.querySelector(`#recordTable tr[data-id="${id}"]`);
      const parent = row ? row.parentNode : null;
      const nextEl = row ? row.nextElementSibling : null;
      const rowHTML = row ? row.outerHTML : null;

      if (row) {
        row.classList.add("removing");
        const delBtn = row.querySelector(".action-btn.danger");
        if (delBtn) {
          delBtn.classList.add("disabled");
          delBtn.textContent = "‚è≥";
          delBtn.title = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...";
        }
        row.remove();
        renumberVisibleRows();
      }

      allRecords = allRecords.filter(r => Number(r.id) !== Number(id));
      showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...", "info", 900);

      try {
        const r = await fetchJSON(`/api/treatment/delete/${id}`, {
          method: "DELETE",
          headers: { "Accept": "application/json" }
        }, 15000);

        if (!r || !r.success) throw new Error("delete failed");
        showToast("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "success", 1400);
      } catch (err) {
        console.error(err);
        allRecords = backupAll;

        if (parent && rowHTML) {
          if (nextEl) nextEl.insertAdjacentHTML("beforebegin", rowHTML);
          else parent.insertAdjacentHTML("beforeend", rowHTML);
          renumberVisibleRows();
        } else {
          renderTable(getFilteredRecordsFromInput());
        }

        showToast("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß)", "error", 2200);
      } finally {
        deletingIds.delete(id);
      }
    }

    // ===================== MEDICINE UI =====================
    function populateMedicineBySymptom(symptom) {
      medSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
      lotSelect.innerHTML = '<option value="">Lot</option>';
      medSelect.style.display = 'block';
      medOther.style.display = 'none';
      medOther.value = "";

      if (symptom === 'other') {
        medSelect.style.display = 'none';
        medOther.style.display = 'block';
        return;
      }

      (medicineData[symptom] || []).forEach(item => {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = item;
        medSelect.appendChild(opt);
      });
    }

    edit_symptom_group.addEventListener("change", () => {
      populateMedicineBySymptom(edit_symptom_group.value);
    });

    async function getMedicineIdByName(name) {
      const k = String(name || "").trim();
      if (!k) return null;
      if (medIdCache.has(k)) return medIdCache.get(k);

      const dataId = await fetchJSON(`/api/medicine_id?name=${encodeURIComponent(k)}`, {}, 12000);
      const medId = dataId?.medicine_id || null;
      medIdCache.set(k, medId);
      return medId;
    }

    async function getLotsByMedicineId(medId) {
      const key = String(medId || "");
      if (!key) return [];
      if (lotCache.has(key)) return lotCache.get(key);

      const dataLots = await fetchJSON(`/api/medicine_lots?medicine_id=${encodeURIComponent(key)}`, {}, 12000);
      const lots = Array.isArray(dataLots?.lots) ? dataLots.lots : [];
      lotCache.set(key, lots);
      return lots;
    }

    medSelect.addEventListener("change", async () => {
      lotSelect.innerHTML = '<option value="">Lot</option>';
      const medName = medSelect.value;
      if (!medName) return;

      try {
        const medId = await getMedicineIdByName(medName);
        if (!medId) {
          console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö medicine_id:", medName);
          return;
        }

        const lots = await getLotsByMedicineId(medId);
        lots.forEach(lot => {
          const opt = document.createElement("option");
          opt.value = lot.id;
          opt.textContent = `${lot.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${lot.remain})`;
          opt.dataset.price = lot.price || 0;
          lotSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        showToast("‡πÇ‡∏´‡∏•‡∏î Lot ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error", 1800);
      }
    });

    function addMedicine() {
      const name = (medSelect.style.display !== "none" ? medSelect.value : medOther.value.trim());
      const lotId = lotSelect.value;
      const lotText = lotSelect.options[lotSelect.selectedIndex]?.text || "";
      const qty = parseInt(qtyInput.value, 10);

      if (!name || !lotId || !qty || qty <= 0) {
        showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error", 1600);
        return;
      }

      editMedicines.push({
        name,
        lot: lotText,
        lot_id: lotId,
        qty,
        price: lotSelect.options[lotSelect.selectedIndex]?.dataset?.price || "-"
      });

      renderMedicineTable();
      qtyInput.value = "";
      lotSelect.innerHTML = '<option value="">Lot</option>';
      if (medOther.style.display !== "none") medOther.value = "";
      if (medSelect.style.display !== "none") medSelect.value = "";
    }

    function removeMedicine(i) {
      editMedicines.splice(i, 1);
      renderMedicineTable();
    }

    // expose for inline onclick
    window.viewRecord = viewRecord;
    window.editRecord = editRecord;
    window.deleteRecord = deleteRecord;
    window.back = back;
    window.addMedicine = addMedicine;
    window.removeMedicine = removeMedicine;

    // ===================== INIT =====================
    document.addEventListener("DOMContentLoaded", () => {
      renderMedicineTable();
      loadRecords();

      const onSearchDebounced = debounce(() => {
        renderTable(getFilteredRecordsFromInput());
      }, 120);

      searchInput.addEventListener("input", onSearchDebounced);
    });
  </script>
</body>
</html>
