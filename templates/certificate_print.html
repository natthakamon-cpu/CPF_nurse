<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Medical_Certificate</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />

    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: "Sarabun", sans-serif; font-size: 12pt; line-height: 1.78; background: white; padding: 0; }
      @page { size: A4; margin: 3mm 5mm; }
      .certificate-container { width: 100%; border: 2px solid #000; padding: 11px; }

      .header-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12pt; }
      .cert-title { text-align: center; font-size: 17pt; font-weight: 700; margin: 5px 0 7px; }

      .section-header { font-weight: 700; font-size: 13pt; margin: 10px 0 5px; display: inline-block; background: #000; color: #fff; padding: 1px 8px; }
      .info-line { margin-bottom: 3px; line-height: 1.78; font-size: 12pt; }

      .underline { display: inline-block; padding: 0 3px; }
      .underline.has-underline { border-bottom: 1px dotted #000; min-width: 100px; }

      .id-boxes { display: inline-flex; gap: 3px; margin: 0 3px; align-items: center; }
      .id-box { width: 19px; height: 24px; border: 1px solid #000; display: inline-flex; align-items: center; justify-content: center; font-size: 11pt; font-weight: 700; }
      .id-separator { display: inline-block; margin: 0 1px; }

      .checkbox { width: 12px; height: 12px; border: 1px solid #000; display: inline-block; margin: 0 2px; vertical-align: middle; position: relative; }
      .checkbox.checked::before { content: "✓"; font-size: 10pt; font-weight: 700; position: absolute; left: 0; top: -3px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

      .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 3px 0; }
      .health-item { margin-bottom: 3px; font-size: 12pt; }
      .signature-area { text-align: right; margin-top: 4px; font-size: 12pt; }

      .note-section { margin-top: 5px; font-size: 10pt; line-height: 1.3; }
      .note-title { font-weight: 700; margin-bottom: 1px; }
      .long-text { text-indent: 2em; margin: 4px 0; line-height: 1.38; font-size: 11pt; }
      .disease-list { margin-left: 2em; line-height: 1.38; font-size: 11pt; }
      .disease-list div { margin-bottom: 2px; }

      @media print {
        body { padding: 0; zoom: 0.87; -webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact; }
        .no-print { display: none !important; }
        @page { size: A4 portrait; margin: 3mm 5mm; }
        .certificate-container { page-break-inside: avoid; }
        .section-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact; }
      }

      .action-buttons { text-align: center; margin: 12px 0; }
      .btn { padding: 8px 20px; font-size: 13pt; font-weight: 600; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; margin: 0 5px; }
      .btn-print { background: #1e88e5; color: white; }
      .btn-back { background: #28a745; color: white; }
    </style>
  </head>

  <body>
    <div class="certificate-container">
      <div class="action-buttons no-print">
        <a href="/medical_certificate" class="btn btn-back">⬅ ย้อนกลับ</a>
        <button class="btn btn-print" onclick="window.print()">🖨️ พิมพ์</button>
      </div>

      <div class="header-row">
        <div>
          เลขที่
          <span class="underline has-underline" style="min-width: 100px" id="cert-number-left">__________</span>
        </div>
        <div>
          เลขที่
          <span class="underline has-underline" style="min-width: 100px" id="cert-number-right">__________</span>
        </div>
      </div>

      <div class="cert-title">ใบรับรองแพทย์</div>

      <!-- ส่วนที่ 1 -->
      <div style="margin-bottom: 6px">
        <div style="margin-bottom: 3px">
          <span class="section-header">ส่วนที่ 1</span>
          <span style="font-weight: 600; font-size: 12pt; margin-left: 8px">ของผู้ขอรับใบรับรองสุขภาพ</span>
        </div>

        <div style="margin-top: 3px">
          <div class="info-line">
            <span>ข้าพเจ้า </span>
            <span class="underline has-underline" style="min-width: 250px; font-weight: 700" id="fullname">________</span>
          </div>

          <div class="info-line">
            <span>ที่อยู่ </span>
            <span class="underline has-underline" style="min-width: 520px" id="address">________</span>
          </div>

          <div class="info-line">
            <span>สถานที่อยู่ (ที่สามารถติดต่อได้) </span>
            <span class="underline has-underline" style="min-width: 400px" id="contact-address">________</span>
          </div>

          <div class="info-line" style="text-align: center; margin: 6px 0">
            <span>หมายเลขบัตรประจำตัวประชาชน</span>
            <div class="id-boxes">
              <div class="id-box" id="id-1">_</div><span class="id-separator">-</span>
              <div class="id-box" id="id-2">_</div><div class="id-box" id="id-3">_</div><div class="id-box" id="id-4">_</div><div class="id-box" id="id-5">_</div><span class="id-separator">-</span>
              <div class="id-box" id="id-6">_</div><div class="id-box" id="id-7">_</div><div class="id-box" id="id-8">_</div><div class="id-box" id="id-9">_</div><div class="id-box" id="id-10">_</div><span class="id-separator">-</span>
              <div class="id-box" id="id-11">_</div><div class="id-box" id="id-12">_</div><span class="id-separator">-</span>
              <div class="id-box" id="id-13">_</div>
            </div>
          </div>

          <div class="info-line"><span>ข้าพเจ้าขอรับใบรับรองสุขภาพ โดยมีประวัติสุขภาพดังนี้</span></div>

          <div class="two-col">
            <div>
              <div class="health-item">
                <div>1. โรคประจำตัว</div>
                <div style="margin-left: 12px">
                  <span class="checkbox" id="disease-no"></span> ไม่มี
                  <span class="checkbox" id="disease-yes"></span> มี (ระบุ)
                  <span class="underline has-underline" style="min-width: 100px" id="disease-detail">_______</span>
                </div>
              </div>

              <div class="health-item">
                <div>2. อุบัติเหตุ และ ผ่าตัด</div>
                <div style="margin-left: 12px">
                  <span class="checkbox" id="accident-no"></span> ไม่มี
                  <span class="checkbox" id="accident-yes"></span> มี (ระบุ)
                  <span class="underline has-underline" style="min-width: 100px" id="accident-detail">_______</span>
                </div>
              </div>
            </div>

            <div>
              <div class="health-item">
                <div>3. เคยเข้ารับการรักษาในโรงพยาบาล</div>
                <div style="margin-left: 12px">
                  <span class="checkbox" id="hospital-no"></span> ไม่มี
                  <span class="checkbox" id="hospital-yes"></span> มี (ระบุ)
                  <span class="underline has-underline" style="min-width: 90px" id="hospital-detail">_______</span>
                </div>
              </div>

              <div class="health-item">
                <div>4. ประวัติอื่นที่สำคัญ</div>
                <div style="margin-left: 12px">
                  <span class="underline has-underline" style="min-width: 200px" id="other-history">_______</span>
                </div>
              </div>
            </div>
          </div>

          <div class="signature-area">
            <div style="margin-top: 3px">
              <span>ลงชื่อ </span>
              <span class="underline has-underline" style="min-width: 120px" id="requester-sign">_______</span>
              <span> วันที่ </span>
              <span class="underline has-underline" style="min-width: 20px" id="req-day">__</span>
              <span> เดือน </span>
              <span class="underline has-underline" style="min-width: 80px" id="req-month">________</span>
              <span> พ.ศ. </span>
              <span class="underline has-underline" style="min-width: 35px" id="req-year">____</span>
            </div>
            <div style="font-size: 10pt; margin-top: 1px">
              ในกรณีเด็กที่ไม่สามารถรับรองตนเองได้ ให้ผู้ปกครองลงนามรับรองแทนได้
            </div>
          </div>
        </div>
      </div>

      <!-- ส่วนที่ 2 -->
      <div style="margin-bottom: 6px">
        <div style="margin-bottom: 3px">
          <span class="section-header">ส่วนที่ 2</span>
          <span style="font-weight: 600; font-size: 12pt; margin-left: 8px">ของแพทย์</span>
        </div>

        <div style="margin-top: 3px">
          <div class="info-line">
            <span>สถานที่ตรวจ </span>
            <span class="underline has-underline" style="min-width: 200px" id="hospital-name">_________________</span>
            <span style="margin-left: 15px">วันที่ </span>
            <span class="underline has-underline" style="min-width: 30px" id="exam-day">___</span>
            <span> เดือน </span>
            <span class="underline has-underline" style="min-width: 60px" id="exam-month">________</span>
            <span> พ.ศ. </span>
            <span class="underline has-underline" style="min-width: 40px" id="exam-year">____</span>
          </div>

          <div class="info-line">
            <span>(1) ข้าพเจ้า นายแพทย์/แพทย์หญิง </span>
            <span class="underline has-underline" style="min-width: 250px" id="doctor-name">_________________________</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>วิชาชีพเวชกรรมเลขที่ </span>
            <span class="underline has-underline" style="min-width: 120px" id="license">____________</span>
          </div>

          <div class="info-line">
            <span>ที่อยู่ </span>
            <span class="underline has-underline" style="min-width: 500px" id="hospital-address">__________________________________________________</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>ได้ตรวจร่างกายนาย/นาง/นางสาว </span>
            <span class="underline has-underline" style="min-width: 250px" id="patient-name">_________________________</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>น้ำหนัก </span>
            <span class="underline has-underline" style="min-width: 40px" id="weight">____</span>
            <span> กก. ส่วนสูง </span>
            <span class="underline has-underline" style="min-width: 40px" id="height">____</span>
            <span> ซม. ความดัน </span>
            <span class="underline has-underline" style="min-width: 60px" id="bp">______</span>
            <span> ชีพจร </span>
            <span class="underline has-underline" style="min-width: 40px" id="pulse">____</span>
            <span> ครั้ง/นาที</span>
          </div>

          <div class="info-line" style="margin-left: 20px">
            <span>สภาพร่างกาย </span>
            <span class="checkbox" id="body-normal"></span> ปกติ
            <span class="checkbox" id="body-abnormal"></span> ผิดปกติ
          </div>

          <div class="long-text">
            ขอรับรองว่า บุคคลดังกล่าว ไม่เป็นผู้มีร่างกายทุพพลภาพจนไม่สามารถปฏิบัติหน้าที่ได้
            ไม่ปรากฏอาการของโรคจิต หรือจิตฟั่นเฟือน หรือปัญญาอ่อน
            ไม่ปรากฏอาการของการติดยาเสพติดให้โทษ และอาการของโรคพิษสุราเรื้อรัง
            และไม่ปรากฏอาการและอาการแสดงของโรคต่อไปนี้
          </div>

          <div class="disease-list">
            <div>(1) โรคเรื้อนในระยะติดต่อ หรือในระยะที่ปรากฏอาการเป็นที่รังเกียจแก่สังคม</div>
            <div>(2) วัณโรคในระยะอันตราย</div>
            <div>(3) โรคเท้าช้างในระยะที่ปรากฏอาการเป็นที่รังเกียจแก่สังคม</div>
            <div>
              (4) อื่น ๆ (ถ้ามี)
              <span class="underline has-underline" style="min-width: 200px" id="other-disease">____________________</span>
            </div>
          </div>

          <div class="info-line">
            <span>(2) สรุปความเห็น </span>
            <span class="checkbox" id="work-ok"></span> สามารถทำงานในที่อับอากาศได้
            <span class="checkbox" id="work-not-ok"></span> ไม่สามารถทำงานในที่อับอากาศได้
          </div>

          <div class="signature-area" style="margin-top: 8px">
            <div>
              <span>ลงชื่อ </span>
              <span class="underline has-underline" style="min-width: 160px" id="doctor-sign">__________________</span>
            </div>
            <div style="margin-top: 1px">แพทย์ผู้ตรวจร่างกาย</div>
          </div>

          <div class="note-section">
            <div class="note-title">หมายเหตุ</div>
            <div>(1) ต้องเป็นแพทย์ซึ่งได้รับขึ้นทะเบียนรับใบอนุญาตประกอบวิชาชีพเวชกรรม</div>
            <div>(2) ใบรับรองแพทย์ฉบับนี้ให้ใช้ได้ 1 เดือนนับแต่วันที่ตรวจร่างกาย</div>
            <div>(3) คำรับรองนี้เป็นการตรวจวินิจฉัยเบื้องต้น</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ✅ ถ้ามี record จาก server ให้ใช้เลย ไม่งั้นเป็น null
      const SERVER_RECORD = {{ record|default(none, true)|tojson|safe }};

      function convertToBuddhistYear(dateString) {
        if (!dateString) return { day: "", month: "", year: "" };
        const date = new Date(dateString);
        const months = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
        return { day: String(date.getDate()), month: months[date.getMonth()], year: String(date.getFullYear() + 543) };
      }

      function fillCitizenId(citizenId) {
        const digits = String(citizenId || "").replace(/\D/g, "");
        for (let i = 1; i <= 13; i++) {
          const box = document.getElementById(`id-${i}`);
          if (box) box.textContent = digits[i - 1] || "_";
        }
      }

      function checkBox(id) {
        const box = document.getElementById(id);
        if (box) box.classList.add("checked");
      }
      function clearAllCheckboxes() {
        document.querySelectorAll(".checkbox").forEach(el => el.classList.remove("checked"));
      }

      function setFieldValue(id, value, defaultBlank = "") {
        const el = document.getElementById(id);
        if (!el) return;

        const v = (value ?? "").toString().trim();
        if (v && !v.match(/^_+$/)) {
          el.textContent = v;
          el.classList.remove("has-underline");
        } else {
          el.textContent = defaultBlank;
          el.classList.add("has-underline");
        }
      }

      function getCertIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const qid = params.get("id");
        if (qid) return qid;

        const parts = window.location.pathname.split("/").filter(Boolean);
        if (parts.length >= 3 && parts[0] === "medical_certificate" && parts[1] === "print") {
          return decodeURIComponent(parts[2]);
        }
        return null;
      }

      function populateForm(data) {
        data = data || {};
        clearAllCheckboxes();

        const certNo = data.certificate_no || data.cert_number || data.certNo || "";
        setFieldValue("cert-number-left", certNo, "__________");
        setFieldValue("cert-number-right", certNo, "__________");

        setFieldValue("fullname", data.fullname || "", "________");
        setFieldValue("address", data.address || "", "________");
        setFieldValue("contact-address", data.address || "", "________");

        fillCitizenId(data.citizenId || data.citizen_id || data.citizenID || "");

        setFieldValue("disease-detail", data.disease_detail || "", "_______");
        setFieldValue("accident-detail", data.accident_detail || "", "_______");
        setFieldValue("hospital-detail", data.hospital_detail || "", "_______");

        if (data.disease === "ไม่มี") checkBox("disease-no");
        if (data.disease === "มี") checkBox("disease-yes");

        if (data.accident === "ไม่มี") checkBox("accident-no");
        if (data.accident === "มี") checkBox("accident-yes");

        if (data.hospital === "ไม่มี") checkBox("hospital-no");
        if (data.hospital === "มี") checkBox("hospital-yes");

        setFieldValue("other-history", data.other_history || "", "_______");

        const reqDate = convertToBuddhistYear(data.requester_date);
        setFieldValue("req-day", reqDate.day, "__");
        setFieldValue("req-month", reqDate.month, "________");
        setFieldValue("req-year", reqDate.year, "____");
        setFieldValue("requester-sign", data.requester_sign || "", "_______");

        setFieldValue("hospital-name", data.hospital_name || "", "_________________");

        const examDate = convertToBuddhistYear(data.exam_date);
        setFieldValue("exam-day", examDate.day, "___");
        setFieldValue("exam-month", examDate.month, "________");
        setFieldValue("exam-year", examDate.year, "____");

        setFieldValue("doctor-name", data.doctor_name || "", "_________________________");
        setFieldValue("license", data.license || "", "____________");
        setFieldValue("hospital-address", data.hospital_address || "", "__________________________________________________");
        setFieldValue("patient-name", data.fullname || "", "_________________________");

        setFieldValue("weight", data.weight || "", "____");
        setFieldValue("height", data.height || "", "____");
        setFieldValue("bp", data.bp || "", "______");
        setFieldValue("pulse", data.pulse || "", "____");

        const bs = (data.body_status || "").toString().trim();
        if (bs === "ปกติ") checkBox("body-normal");
        else if (bs) checkBox("body-abnormal");

        setFieldValue("other-disease", data.other_disease || "", "____________________");

        if (data.work_result === "ได้") checkBox("work-ok");
        if (data.work_result === "ไม่ได้") checkBox("work-not-ok");

        setFieldValue("doctor-sign", data.doctor_sign || "", "__________________");
      }

      async function loadData() {
        // 1) ถ้า server ส่งมาแล้ว
        if (SERVER_RECORD && typeof SERVER_RECORD === "object") {
          populateForm(SERVER_RECORD);
          return;
        }

        // 2) ถ้ามี id -> fetch
        const certId = getCertIdFromUrl();
        if (certId) {
          try {
            const res = await fetch(`/api/medical_certificate/${encodeURIComponent(certId)}`, { credentials: "same-origin" });
            const json = await res.json();
            const ok = !!(json && (json.success || json.ok));
            const rec = ok ? (json.data || json.record) : null;
            if (rec) populateForm(rec);
          } catch (err) {
            console.error("Error loading certificate:", err);
          }
          return;
        }

        // 3) fallback localStorage
        const tempData = localStorage.getItem("tempCertificateData");
        if (tempData) {
          populateForm(JSON.parse(tempData));
          localStorage.removeItem("tempCertificateData");
        }
      }

      document.addEventListener("DOMContentLoaded", loadData);
    </script>
  </body>
</html>
