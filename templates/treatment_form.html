<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --blue: #2196f3;
      --blue-dark: #1976d2;
      --border: #cfd8dc;
      --bg: #f4f6f8;

      /* ‚úÖ ‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏ô‡∏≤‡∏î radio ‡∏ï‡∏≤‡∏°‡∏à‡∏≠ */
      --radio-scale: 1.8; /* desktop */
    }

    * {
      box-sizing: border-box;
    }

    /* ‚úÖ ‡∏Å‡∏±‡∏ô iOS Safari ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏≠‡∏á‡∏à‡∏ô layout ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô */
    html {
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;

      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* ===== container ===== */
    .container {
      max-width: 1500px;
      background: #fff;
      margin: 40px auto;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      position: relative;
      font-size: 24px;
    }

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å ===== */
    .back-menu-btn {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      font-size: 20px;
      border-radius: 8px;
      text-decoration: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: 0.2s;
    }

    .back-menu-btn:hover {
      background: #218838;
    }

    .top-bar {
      text-align: left;
    }

    /* ===== heading ===== */
    h2 {
      text-align: center;
      margin-bottom: 35px;
      font-size: 32px;
      font-weight: 700;
      color: #0d47a1;
    }

    /* ===== label ===== */
    label {
      font-weight: 600;
      display: block;
      margin-top: 20px;
      margin-bottom: 6px;
    }

    /* ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ input ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á ‡πÜ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° radio/checkbox) */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 14px 18px;
      font-size: 24px;
      box-sizing: border-box;
      border-radius: 18px;
      border: 1px solid var(--border);
      font-family: 'Sarabun', sans-serif;
      transition: .2s;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.25);
    }

    /* ===== inline (radio group) ===== */
    .inline {
      display: flex;
      gap: 30px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï radio/checkbox ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô width/padding ‡∏Ç‡∏≠‡∏á input ‡∏´‡∏•‡∏±‡∏Å */
    input[type="radio"],
    input[type="checkbox"] {
      width: auto !important;
      padding: 0 !important;
      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }

    /* ‚úÖ ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ß‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô */
    .inline label {
      margin: 0;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      line-height: 1;
      white-space: nowrap;
    }

    .inline input[type="radio"] {
      margin: 0;
      cursor: pointer;
      transform: scale(var(--radio-scale));
      transform-origin: center;
      flex: 0 0 auto;
      accent-color: var(--blue);
    }

    /* ===== add / submit buttons ===== */
    button {
      font-family: 'Sarabun', sans-serif;
      font-size: 22px;
      padding: 12px 20px;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      transition: .2s;
    }

    button[type="submit"],
    .add-btn {
      background: var(--blue);
      color: #fff;
    }

    button[type="submit"]:hover,
    .add-btn:hover {
      background: var(--blue-dark);
    }

    /* ===== medicine add row ===== */
    .medicine-row button {
      background: var(--blue);
      color: #fff;
    }

    /* ===== table ===== */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      border-radius: 18px;
      overflow: hidden;
    }

    th {
      background: linear-gradient(135deg, #bbdefb, #90caf9);
      color: #0d47a1;
      padding: 16px;
      font-weight: 700;
      text-align: center;
    }

    td {
      padding: 14px;
      text-align: center;
      border-top: 1px solid #e0e0e0;
    }

    tr:hover td {
      background: #f5faff;
    }

    /* ===== delete button ===== */
    table button {
      background: #ef5350;
      color: #fff;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      padding: 0;
    }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }

    /* ‚úÖ iPad / Tablet: ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î radio + ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
    @media (max-width: 1024px) {
      :root { --radio-scale: 1.25; }
      .inline { gap: 18px; }
      .inline label { font-size: 20px; }
    }

    /* ‚úÖ Mobile: ‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î */
    @media (max-width: 600px) {
      :root { --radio-scale: 1.15; }
      .container { padding: 20px; }
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π -->
    <div class="top-bar">
      <a href="/menu" class="back-menu-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π</a>
    </div>

    <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>

    <form method="post">

      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
      <input type="date" name="visit_date" required>

      <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
      <input type="text" name="patient_name" required>

      <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
      <select name="department">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
        <option>‡∏≠‡∏™‡∏£.</option>
        <option>‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</option>
        <option>‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</option>
        <option>‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
        <option>‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•</option>
        <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option>
        <option>‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</option>
        <option>‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
        <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>

      <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
      <select id="symptom_group" name="symptom_group">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
        <option value="respiratory">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</option>
        <option value="digestive">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
        <option value="muscle">‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</option>
        <option value="brain">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á</option>
        <option value="skin">‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</option>
        <option value="medicine">‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
        <option value="urinary">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢</option>
        <option value="reproductive">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
        <option value="eye">‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å</option>
        <option value="throat">‡∏Ñ‡∏≠</option>
        <option value="nose">‡∏à‡∏°‡∏π‡∏Å</option>
        <option value="wound">‡∏ó‡∏≥‡πÅ‡∏ú‡∏•</option>
        <option value="work_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</option>
        <option value="nonwork_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</option>
        <option value="supply">‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</option>
        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
      <textarea name="symptom_detail" rows="3"></textarea>

      <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>

      <div style="display:flex; gap:10px; align-items:center;" class="medicine-row">

        <select id="medicine_select" style="flex:3;">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
        </select>

        <input type="text" id="medicine_other" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå" style="flex:3; display:none;">

        <select id="lot_select" style="flex:2;">
          <option value="">Lot</option>
        </select>

        <input type="number" id="qty_input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" style="flex:1;">

        <button type="button" class="add-btn" onclick="addMedicine()" style="flex:1;">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
        </button>

      </div>

      <table id="medicine_table">
        <tr>
          <th>‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
          <th>Lot</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th>‡∏•‡∏ö</th>
        </tr>
      </table>

      <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
      <div class="inline">
        <label><input type="radio" name="allergy" value="0" checked> ‡πÑ‡∏°‡πà‡πÅ‡∏û‡πâ</label>
        <label><input type="radio" name="allergy" value="1"> ‡πÅ‡∏û‡πâ</label>
      </div>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
      <textarea name="allergy_detail" rows="2"></textarea>

      <label style="margin-top:30px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>

      <label style="font-weight:500;">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
      </label>

      <div class="inline">
        <label>
          <input type="radio" name="occupational_disease" value="0" checked>
          ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
        </label>
        <label>
          <input type="radio" name="occupational_disease" value="1">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
        </label>
      </div>

      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
      <textarea name="doctor_opinion" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå"></textarea>

      <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</button>

      <input type="hidden" name="medicine_json" id="medicine_json">

    </form>
  </div>

<script>
  /* ===============================
     ELEMENTS
  ================================ */
  const symptom   = document.getElementById('symptom_group');
  const medSelect = document.getElementById('medicine_select');
  const medOther  = document.getElementById('medicine_other');
  const qtyInput  = document.getElementById('qty_input');
  const lotSelect = document.getElementById('lot_select');
  const table     = document.getElementById('medicine_table');
  const form      = document.querySelector("form");

  let medicines = [];

  /* ===============================
     (OPTIONAL) FALLBACK DATA: ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì
     - ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ API ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
  ================================ */
  const medicineData = {
    respiratory: ['Amoxy', 'Bisolvon', 'Mybacin', 'Loratadine', 'Zyetec', 'M.tusis'],
    digestive: ['Air-x', 'K milk120cc', 'Buscopan', 'Diasgest', 'M.car', 'ORS', 'Paracetamol(500)', 'Motilium', 'K-milk', '‡∏¢‡∏≤‡∏´‡∏≠‡∏°', 'CA-R-Bon'],
    muscle: ['Balm', 'Mydoclam', 'Norgesic'],
    brain: ['B1,6,12', 'Dimen', 'ORS', 'Paracetamol(500)'],
    skin: ['Acyclovir', 'CPM', 'Loratadine', 'Zyetec', '0.1%TA Cream', 'Mycozol', 'Silver cream', 'Calamine lotion'],
    urinary: ['Paracetamol(500)', 'Norflox'],
    reproductive: ['Ponstan(500)'],
    eye: ['Hista oph', 'Op Sar', 'Ointment', 'Brufen(400)', 'Kenalog'],
    wound: ['Plaster', '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ'],
    supply: [
      '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ', 'EB:3', 'EB:2', 'Mask', 'Grove Dispose', 'Eyepad', 'Transpore',
      'Sofatulle', '‡πÑ‡∏°‡πâ‡∏Å‡∏î‡∏•‡∏¥‡πâ‡∏ô', 'Gouze', 'Betadine', '70%Alcohol', '0.9%NSS', 'Amora',
      '‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏îMET', '‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏îHTC', '‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏≥‡πÅ‡∏ú‡∏• D/S', '‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£',
      '‡∏ñ‡πâ‡∏ß‡∏¢‡∏¢‡∏≤', '‡πÄ‡∏Ç‡πá‡∏°‡∏Å‡∏•‡∏±‡∏î', '‡∏õ‡∏£‡∏≠‡∏ó‡∏ß‡∏±‡∏î‡πÑ‡∏Ç‡πâ', '‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏π‡πà', '‡∏ú‡πâ‡∏≤‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°',
      '‡∏™‡∏≤‡∏¢‡∏¢‡∏≤‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î', '‡∏´‡∏•‡∏≠‡∏î‡∏´‡∏¢‡∏î‡∏¢‡∏≤', '‡∏ñ‡πâ‡∏ß‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤', '‡∏™‡∏≤‡∏¢02 Canula',
      '‡∏™‡∏≤‡∏¢02 Mask with Bag', '‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤‡∏á‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢'
    ]
  };

  /* ===============================
     HELPERS
  ================================ */
  function resetLotAndQty() {
    lotSelect.innerHTML = '<option value="">Lot</option>';
    qtyInput.value = "";
  }

  function getItemType() {
    if (symptom.value === "other") return "other";
    if (symptom.value === "supply") return "supply";
    return "medicine";
  }

  function showSelectMode() {
    medSelect.style.display = "block";
    medOther.style.display  = "none";
  }

  function showOtherInputMode() {
    medSelect.style.display = "none";
    medOther.style.display  = "block";
    medOther.value = "";
  }

  function setMedOptions(names) {
    medSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
    (names || []).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      medSelect.appendChild(opt);
    });
  }

  async function loadOtherItemsToSelect() {
    medSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
    try {
      const res = await fetch("/api/other_items");
      const items = await res.json(); // [{id,name}] ‡∏´‡∏£‡∏∑‡∏≠ list
      (items || []).forEach(it => {
        const name = (it && it.name) ? it.name : it;
        if (!name) return;
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        medSelect.appendChild(opt);
      });
    } catch (e) {
      console.error("‡πÇ‡∏´‡∏•‡∏î other_items ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e);
      showOtherInputMode();
    }
  }

  async function loadMedicineItemsByGroup() {
    resetLotAndQty();

    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
    if (!symptom.value) {
      setMedOptions([]);
      showSelectMode();
      return;
    }

    // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    if (symptom.value === "other") {
      showSelectMode();
      await loadOtherItemsToSelect();
      return;
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á label ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å option ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à")
    const groupLabel = symptom.options[symptom.selectedIndex]?.textContent?.trim() || "";
    const code = symptom.value;

    showSelectMode();
    setMedOptions([]);

    try {
      const res = await fetch(`/api/medicine_items?group=${encodeURIComponent(groupLabel)}&code=${encodeURIComponent(code)}`);
      if (!res.ok) throw new Error("API /api/medicine_items ‡πÑ‡∏°‡πà OK");
      const data = await res.json(); // {items:[...]} ‡∏´‡∏£‡∏∑‡∏≠ list

      const items = Array.isArray(data) ? data : (data.items || data.data || []);
      if (items.length > 0) {
        setMedOptions(items);
      } else {
        // fallback ‡πÄ‡∏õ‡πá‡∏ô hardcode ‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
        const fallback = medicineData[symptom.value] || [];
        if (fallback.length > 0) setMedOptions(fallback);
        else showOtherInputMode();
      }
    } catch (e) {
      console.warn("‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ fallback:", e);
      const fallback = medicineData[symptom.value] || [];
      if (fallback.length > 0) setMedOptions(fallback);
      else showOtherInputMode();
    }
  }

  /* ===============================
     CHANGE SYMPTOM
  ================================ */
  symptom.addEventListener('change', loadMedicineItemsByGroup);

  /* ===============================
     LOAD LOT
  ================================ */
  medSelect.addEventListener('change', async () => {
    lotSelect.innerHTML = '<option value="">Lot</option>';
    if (!medSelect.value) return;

    const itemType = getItemType();

    // ‚úÖ CASE: other ‚Üí other_lot
    if (itemType === "other") {
      const lotRes = await fetch(`/api/other_lots?item_name=${encodeURIComponent(medSelect.value)}`);
      const data = await lotRes.json();

      const lots = data.lots || data.items || data.data || [];
      if (!lots || lots.length === 0) {
        console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö LOT ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ:", medSelect.value);
        return;
      }

      lots.forEach(lot => {
        const opt = document.createElement('option');
        opt.value = lot.id;
        opt.textContent = `${lot.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${lot.remain})`;
        opt.dataset.lotName = lot.name;          // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ lot ‡∏à‡∏£‡∏¥‡∏á
        opt.dataset.price   = lot.price || 0;    // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢
        lotSelect.appendChild(opt);
      });
      return;
    }

    // ‚úÖ CASE: medicine / supply ‚Üí medicine_lots (‡∏î‡∏∂‡∏á‡∏î‡πâ‡∏ß‡∏¢ name)
    const lotRes = await fetch(`/api/medicine_lots?name=${encodeURIComponent(medSelect.value)}`);
    const data = await lotRes.json();

    const lots = data.lots || data.items || data.data || [];
    if (!lots || lots.length === 0) {
      console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö LOT:", medSelect.value);
      return;
    }

    lots.forEach(lot => {
      const opt = document.createElement('option');
      opt.value = lot.id;
      opt.textContent = `${lot.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${lot.remain})`;
      opt.dataset.lotName = lot.name;        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ lot ‡∏à‡∏£‡∏¥‡∏á
      opt.dataset.price   = lot.price || 0;  // ‚úÖ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢
      lotSelect.appendChild(opt);
    });
  });

  /* ===============================
     ADD ITEM
  ================================ */
  function addMedicine() {
    const itemType = getItemType();

    const itemName = (medSelect.style.display !== "none")
      ? medSelect.value
      : medOther.value.trim();

    if (!itemName || !lotSelect.value || !qtyInput.value) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      return;
    }

    const qty = parseInt(qtyInput.value, 10);
    if (!qty || qty <= 0) {
      alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
      return;
    }

    const selected = lotSelect.options[lotSelect.selectedIndex];
    const lotText = selected.textContent || "";
    const remainMatch = lotText.match(/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠\s+(\d+)/);
    const remain = remainMatch ? parseInt(remainMatch[1], 10) : null;

    if (remain !== null && qty > remain) {
      alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô Lot ‡∏ô‡∏µ‡πâ");
      return;
    }

    const uid = Date.now() + "_" + Math.random().toString(16).slice(2);

    const lotName = selected.dataset.lotName || selected.textContent; // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ LOT ‡∏à‡∏£‡∏¥‡∏á

    const obj = {
      uid,
      type: itemType,          // "other" / "medicine" / "supply"
      name: itemName,
      lot: lotName,            // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà LOT-1 ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ "(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠..)"
      lot_id: lotSelect.value,
      qty: qty,
      price_per_unit: Number(selected.dataset.price || 0)
    };

    medicines.push(obj);

    const row = table.insertRow();
    row.dataset.uid = uid;

    row.insertCell(0).innerText = itemName;
    row.insertCell(1).innerText = lotName;
    row.insertCell(2).innerText = qty;
    row.insertCell(3).innerText = (selected.dataset.price !== undefined) ? selected.dataset.price : "-";
    row.insertCell(4).innerHTML =
      `<button type="button" onclick="removeRow('${uid}')">‚ùå</button>`;

    resetLotAndQty();
  }

  function removeRow(uid) {
    medicines = medicines.filter(x => x.uid !== uid);
    const tr = table.querySelector(`tr[data-uid="${uid}"]`);
    if (tr) tr.remove();
  }

  /* ===============================
     SUBMIT
  ================================ */
  form.addEventListener("submit", e => {
    if (medicines.length === 0) {
      e.preventDefault();
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
      return;
    }

    medicines = medicines.map(m => ({
      ...m,
      type: (m.type || "").trim() || getItemType()
    }));

    document.getElementById("medicine_json").value = JSON.stringify(medicines);
  });

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ preset)
  // loadMedicineItemsByGroup();
</script>


  <div class="footer">
    ¬© 2026 Safety Officer, CPF Khon Kaen Feedmill
  </div>
</body>

</html>
