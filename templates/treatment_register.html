<!DOCTYPE html>

<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    .header {
      font-size: 16px;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
    }

    .container {
      font-size: 24px;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;

      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }

    .header-left i {
      font-size: 26px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      font-size: 24px;
      background: #f4f6f9;
      margin: 0;
    }

    .box {
      position: relative;
      background: #fff;
      padding: 40px;
      border-radius: 14px;
      max-width: 1500px;
      margin: 40px auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }

    /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ top-bar ‡∏Ñ‡∏∏‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏∏‡πà‡∏° */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 20px;
    }

    /* ‚úÖ ‡πÅ‡∏Å‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ absolute ‡πÅ‡∏•‡πâ‡∏ß */
    .save-btn {
      position: static;
      display: inline-flex;
      align-items: center;
      gap: 10px;

      background: #28a745;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 18px;
      font-weight: 600;
    }

    .save-btn:hover {
      opacity: .92;
    }

    h2 {
      margin-top: 10px;
      margin-bottom: 25px;
      font-size: 32px;
      font-weight: 700;
      text-align: center;
    }

    .search {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 24px;
      border-radius: 14px;
      border: 1px solid #bbb;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 14px;
      overflow: hidden;
    }

    th,
    td {
      border: 1px solid #cfd8dc;
      padding: 12px;
      text-align: center;
    }

    th {
      background: #90CAF9;
      color: #0d47a1;
    }

    .action-btn {
      cursor: pointer;
      margin: 0 6px;
      font-size: 22px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .back-btn {
      margin-top: 25px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #e0e0e0;
      cursor: pointer;
      font-size: 20px;
    }

    /* ===== EDIT PAGE LAYOUT ===== */
    #page-edit form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 22px 40px;
      align-items: start;
    }

    #page-edit label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    #page-edit input,
    #page-edit select,
    #page-edit textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 22px;
      border-radius: 12px;
      border: 1px solid #b0bec5;
      box-sizing: border-box;
    }

    /* textarea ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß */
    #page-edit textarea {
      grid-column: 1 / -1;
    }

    /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤ / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß */
    #page-edit .medicine-group {
      grid-column: 1 / -1;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≤ */
    #medicine_table th {
      background: #e3f2fd;
      color: #0d47a1;
    }

    /* ===== RADIO ALLERGY (‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô) ===== */
    .inline {
      grid-column: 1 / -1;
      display: flex;
      gap: 40px;
      align-items: center;
      margin-top: 5px;
    }

    .inline input[type="radio"] {
      transform: scale(1.8);
      margin-right: 10px;
      cursor: pointer;
    }

    .inline label {
      font-size: 22px;
      cursor: pointer;
    }

    /* ===== BUTTON ZONE ===== */
    .edit-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .btn-save {
      background: #2196f3;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
    }

    .btn-cancel {
      background: #e53935;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
    }

    .btn-back {
      background: #9e9e9e;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 22px;
      cursor: pointer;
    }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }

    /* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏Å‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    th.col-actions,
    td.col-actions {
      white-space: nowrap;
      width: 140px;
      text-align: center;
    }

    /* ‡∏´‡πà‡∏≠‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô flex ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    .action-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;

      width: 38px;
      height: 38px;
      border-radius: 10px;

      cursor: pointer;
      user-select: none;
      line-height: 1;
      font-size: 20px;
    }

    .action-btn:active {
      transform: scale(0.96);
    }

    .action-btn.danger {
      filter: saturate(1.2);
    }

    /* ‚úÖ Toast ‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI */
    .toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      z-index: 9999;
      background: #333;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 18px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .25);
      max-width: min(520px, calc(100vw - 48px));
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: #1b7f3a;
    }

    .toast.error {
      background: #b3261e;
    }

    .toast.info {
      background: #2a2a2a;
    }

    /* ‚úÖ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡∏•‡∏ö */
    tr.removing {
      opacity: .45;
      filter: grayscale(1);
    }

    /* ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏Ç‡∏ì‡∏∞‡∏•‡∏ö */
    .action-btn.disabled {
      pointer-events: none;
      opacity: .55;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">
    <!-- ================= LIST ================= -->
    <div id="page-list" class="box page active">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π -->
      <div class="top-bar">
        <a href="/treatment_menu" class="save-btn">
          <i class="fa-solid fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        </a>
      </div>

      <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
      <input type="text" id="searchInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" onkeyup="filterTable()">
      <table id="recordTable"></table>
    </div>

    <!-- ================= VIEW ================= -->
    <div id="page-view" class="box page">
      <div class="top-bar">
        <a href="/treatment_menu" class="save-btn">
          <i class="fa-solid fa-arrow-left"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        </a>
      </div>

      <h2>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
      <div id="viewBox"></div>
      <button class="back-btn" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>

    <!-- ================= EDIT ================= -->
    <div id="page-edit" class="box page">
      <div class="top-bar">
        <a href="/treatment_menu" class="save-btn">
          <i class="fa-solid fa-arrow-left"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        </a>
      </div>

      <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>

      <form id="editForm">
        <input type="hidden" id="edit_id">

        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
        <input type="date" name="visit_date" id="edit_date" required>

        <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
        <input type="text" name="patient_name" id="edit_name" required>

        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
        <select name="department" id="edit_department">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option>‡∏≠‡∏™‡∏£.</option>
          <option>‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
          <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</option>
          <option>‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</option>
          <option>‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
          <option>‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•</option>
          <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option>
          <option>‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</option>
          <option>‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
          <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
        <select name="symptom_group" id="edit_symptom_group">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value="respiratory">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</option>
          <option value="digestive">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
          <option value="muscle">‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</option>
          <option value="brain">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á</option>
          <option value="skin">‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</option>
          <option value="medicine">‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
          <option value="urinary">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢</option>
          <option value="reproductive">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
          <option value="eye">‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å</option>
          <option value="throat">‡∏Ñ‡∏≠</option>
          <option value="nose">‡∏à‡∏°‡∏π‡∏Å</option>
          <option value="wound">‡∏ó‡∏≥‡πÅ‡∏ú‡∏•</option>
          <option value="work_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</option>
          <option value="nonwork_accident">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</option>
          <option value="supply">‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</option>
          <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
        <textarea name="symptom_detail" id="edit_symptom" rows="3"></textarea>

        <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
        <div class="medicine-group">
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <select id="medicine_select" style="flex:3;">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
            </select>

            <input type="text" id="medicine_other" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå" style="flex:3; display:none;">

            <select id="lot_select" style="flex:2;">
              <option value="">Lot</option>
            </select>

            <input type="number" id="qty_input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" style="flex:1;">

            <button type="button" onclick="addMedicine()" style="flex:1;">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
          </div>

          <table width="100%" id="medicine_table"></table>
        </div>

        <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
        <div class="inline">
          <label><input type="radio" name="allergy" value="0"> ‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
          <label><input type="radio" name="allergy" value="1"> ‡∏°‡∏µ</label>
        </div>

        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
        <textarea name="allergy_detail" id="edit_allergy_detail" rows="2"></textarea>

        <!-- ===== ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå ===== -->
        <div style="grid-column:1 / -1; margin-top:30px;">
          <label style="font-size:26px; font-weight:700;">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå
          </label>

          <label style="font-weight:500; margin-top:10px;">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
          </label>

          <div class="inline">
            <label>
              <input type="radio" name="occupational_disease" value="0">
              ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
            </label>
            <label>
              <input type="radio" name="occupational_disease" value="1">
              ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢
            </label>
          </div>

          <label style="margin-top:15px;">
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå
          </label>

          <textarea id="edit_doctor_opinion" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå"></textarea>
        </div>

        <div class="edit-actions">
          <button type="submit" class="btn-save">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button type="button" class="btn-cancel" onclick="back()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn-back" onclick="back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
      </form>
    </div>

    <script>
      const symptomLabelMap = {
        respiratory: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à",
        digestive: "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
        muscle: "‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
        brain: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≠‡∏á",
        skin: "‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á",
        medicine: "‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°",
        urinary: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢",
        reproductive: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå",
        eye: "‡∏ï‡∏≤ ‡∏´‡∏π ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å",
        throat: "‡∏Ñ‡∏≠",
        nose: "‡∏à‡∏°‡∏π‡∏Å",
        wound: "‡∏ó‡∏≥‡πÅ‡∏ú‡∏•",
        work_accident: "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô",
        nonwork_accident: "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏≠‡∏Å‡∏á‡∏≤‡∏ô",
        supply: "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå",
        other: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
      };

      function symptomLabel(code) {
        if (!code) return "-";
        return symptomLabelMap[code] || code;
      }

      /* ===============================
         TABLE RENDER (SQLite)
      ================================ */
      let allRecords = [];
      const deletingIds = new Set(); // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏•‡∏ö‡∏ã‡πâ‡∏≥

      function safeText(v) {
        return (v === null || v === undefined || v === "") ? "-" : v;
      }

      function formatMeds(medicineText) {
        if (!medicineText) return "-";
        try {
          const items = JSON.parse(medicineText);
          if (!Array.isArray(items) || items.length === 0) return "-";
          return items.map(it => {
            const name = it.name || "-";
            const lot = it.lot || "";
            const qty = it.qty || "";
            return `${name}${lot ? " " + lot : ""}${qty ? " x" + qty : ""}`;
          }).join(", ");
        } catch (e) {
          return medicineText;
        }
      }

      // ‚úÖ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô: build string ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ innerHTML += ‡πÉ‡∏ô loop
      function renderTable(records) {
        const table = document.getElementById('recordTable');

        let html = `
          <tr>
            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
            <th class="col-actions">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        `;

        if (!records || records.length === 0) {
          html += `
            <tr>
              <td colspan="5" style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
            </tr>
          `;
          table.innerHTML = html;
          return;
        }

        for (let i = 0; i < records.length; i++) {
          const r = records[i];
          html += `
            <tr data-id="${r.id}">
              <td>${i + 1}</td>
              <td>${safeText(r.visit_date)}</td>
              <td>${safeText(r.patient_name)}</td>
              <td>${symptomLabel(r.symptom_group)}</td>
              <td class="col-actions">
                <div class="action-wrap">
                  <span class="action-btn" onclick="viewRecord(${r.id})" title="‡∏î‡∏π">üëÅÔ∏è</span>
                  <span class="action-btn" onclick="editRecord(${r.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</span>
                  <span class="action-btn danger" onclick="deleteRecord(${r.id})" title="‡∏•‡∏ö">üóëÔ∏è</span>
                </div>
              </td>
            </tr>
          `;
        }

        table.innerHTML = html;
      }

      /* ===============================
         LOAD LIST (SQLite)
      ================================ */
      async function loadRecords() {
        const res = await fetch("/api/treatment_list", { cache: "no-store" });
        allRecords = await res.json();
        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ render ‡∏ï‡∏≤‡∏° filter ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        renderTable(getFilteredRecordsFromInput());
      }

      function showToast(msg, type = "info", ms = 1400) {
        const el = document.getElementById("toast");
        if (!el) return;
        el.className = `toast ${type}`;
        el.textContent = msg;
        el.classList.add("show");
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(() => el.classList.remove("show"), ms);
      }

      function getFilteredRecordsFromInput() {
        const q = (document.getElementById("searchInput").value || "").toLowerCase().trim();
        if (!q) return allRecords;

        return allRecords.filter(r =>
          (r.patient_name || "").toLowerCase().includes(q) ||
          (r.visit_date || "").includes(q) ||
          formatMeds(r.medicine).toLowerCase().includes(q)
        );
      }

      function filterTable() {
        renderTable(getFilteredRecordsFromInput());
      }

      // ‚úÖ ‡πÄ‡∏£‡πá‡∏ß: renumber ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà rebuild ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
      function renumberVisibleRows() {
        const rows = document.querySelectorAll("#recordTable tr[data-id]");
        rows.forEach((tr, idx) => {
          const td0 = tr.children[0];
          if (td0) td0.textContent = String(idx + 1);
        });
      }

      /* ===============================
         PAGE SWITCH
      ================================ */
      function switchPage(id) {
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById(id).classList.add("active");
      }
      function back() { switchPage("page-list"); }

      /* ===============================
         VIEW (SQLite)
      ================================ */
      function viewRecord(id) {
        fetch(`/api/treatment/${id}`, { cache: "no-store" })
          .then(res => res.json())
          .then(r => {
            if (!r.success) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const d = r.data;

            document.getElementById("viewBox").innerHTML = `
              <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</b> ${safeText(d.visit_date)}</p>
              <p><b>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</b> ${safeText(d.patient_name)}</p>
              <p><b>‡πÅ‡∏ú‡∏ô‡∏Å:</b> ${safeText(d.department)}</p>
              <p><b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${symptomLabel(d.symptom_group)}</p>
              <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${safeText(d.symptom_detail)}</p>
              <p><b>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå:</b> ${formatMeds(d.medicine)}</p>
              <p><b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</b> ${d.allergy == 1 ? "‡∏°‡∏µ" : "‡πÑ‡∏°‡πà‡∏°‡∏µ"}</p>
              <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</b> ${safeText(d.allergy_detail)}</p>
              <p><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b> ${d.occupational_disease == 1 ? "‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢" : "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢"}</p>
              <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b> ${safeText(d.doctor_opinion)}</p>
            `;
            switchPage("page-view");
          });
      }

      /* ===============================
         EDIT
      ================================ */
      let editMedicines = [];

      const edit_id = document.getElementById("edit_id");
      const edit_date = document.getElementById("edit_date");
      const edit_name = document.getElementById("edit_name");
      const edit_department = document.getElementById("edit_department");
      const edit_symptom_group = document.getElementById("edit_symptom_group");
      const edit_symptom = document.getElementById("edit_symptom");
      const edit_allergy_detail = document.getElementById("edit_allergy_detail");
      const edit_doctor_opinion = document.getElementById("edit_doctor_opinion");

      function renderMedicineTable() {
        const table = document.getElementById("medicine_table");
        table.innerHTML = `
          <tr>
            <th>‡∏¢‡∏≤</th><th>Lot</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏•‡∏ö</th>
          </tr>
        `;
        editMedicines.forEach((m, i) => {
          table.innerHTML += `
            <tr>
              <td>${safeText(m.name)}</td>
              <td>${safeText(m.lot)}</td>
              <td>${safeText(m.qty)}</td>
              <td>${safeText(m.price)}</td>
              <td><button type="button" onclick="removeMedicine(${i})">üóëÔ∏è</button></td>
            </tr>
          `;
        });
      }
      function removeMedicine(i) {
        editMedicines.splice(i, 1);
        renderMedicineTable();
      }

      function editRecord(id) {
        fetch(`/api/treatment/${id}`, { cache: "no-store" })
          .then(res => res.json())
          .then(r => {
            if (!r.success) {
              alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
              return;
            }
            const d = r.data;

            edit_id.value = d.id;
            edit_date.value = d.visit_date || "";
            edit_name.value = d.patient_name || "";
            edit_department.value = d.department || "";
            edit_symptom_group.value = d.symptom_group || "";
            edit_symptom.value = d.symptom_detail || "";
            edit_allergy_detail.value = d.allergy_detail || "";
            edit_doctor_opinion.value = d.doctor_opinion || "";

            const occ = document.querySelector(`input[name="occupational_disease"][value="${d.occupational_disease}"]`);
            if (occ) occ.checked = true;

            const al = document.querySelector(`input[name="allergy"][value="${d.allergy}"]`);
            if (al) al.checked = true;

            editMedicines = [];
            try { editMedicines = JSON.parse(d.medicine || "[]"); } catch (e) { }
            renderMedicineTable();

            switchPage("page-edit");
          })
          .catch(err => {
            console.error(err);
            alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          });
      }

      /* ===============================
         DELETE (SQLite)  ‚úÖ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å
      ================================ */
      async function deleteRecord(id) {
        if (deletingIds.has(id)) return; // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;

        deletingIds.add(id);

        // --- ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ rollback ---
        const backupAll = allRecords.slice();
        const row = document.querySelector(`#recordTable tr[data-id="${id}"]`);
        const parent = row ? row.parentNode : null;
        const nextEl = row ? row.nextElementSibling : null;
        const rowHTML = row ? row.outerHTML : null;

        // --- ‡∏ó‡∏≥ UI ‡πÉ‡∏´‡πâ ‚Äú‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‚Äù ---
        if (row) {
          row.classList.add("removing");
          const delBtn = row.querySelector(".action-btn.danger");
          if (delBtn) {
            delBtn.classList.add("disabled");
            delBtn.textContent = "‚è≥";
            delBtn.title = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...";
          }
          // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà rebuild ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
          row.remove();
          renumberVisibleRows();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡πÉ‡∏ô memory ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        allRecords = allRecords.filter(r => Number(r.id) !== Number(id));

        showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...", "info", 900);

        // --- ‡∏¢‡∏¥‡∏á API ‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏≠ UI) ---
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 12000); // 12s ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á

        try {
          const res = await fetch(`/api/treatment/delete/${id}`, {
            method: "DELETE",
            headers: { "Accept": "application/json" },
            cache: "no-store",
            keepalive: true,
            signal: controller.signal
          });
          clearTimeout(t);

          const r = await res.json().catch(() => ({}));
          if (!res.ok || !r.success) throw new Error(r?.error || "delete failed");

          showToast("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "success", 1400);
        } catch (err) {
          clearTimeout(t);
          console.error(err);

          // rollback state
          allRecords = backupAll;

          // rollback DOM ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          if (parent && rowHTML) {
            if (nextEl) nextEl.insertAdjacentHTML("beforebegin", rowHTML);
            else parent.insertAdjacentHTML("beforeend", rowHTML);
            renumberVisibleRows();
          } else {
            // fallback: re-render ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            renderTable(getFilteredRecordsFromInput());
          }

          showToast("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß)", "error", 2200);
        } finally {
          deletingIds.delete(id);
        }
      }

      /* ===============================
         INIT
      ================================ */
      document.addEventListener("DOMContentLoaded", () => {
        loadRecords();
      });

      /* ===============================
         ADD MEDICINE IN EDIT (use med_id + lots)
      ================================ */
      const medSelect = document.getElementById("medicine_select");
      const medOther = document.getElementById("medicine_other");
      const lotSelect = document.getElementById("lot_select");
      const qtyInput = document.getElementById("qty_input");

      const medicineData = {
        respiratory: ['Amoxy', 'Bisolvon', 'Mybacin', 'Loratadine', 'Zyetec', 'M.tusis'],
        digestive: ['Air-x', 'K milk120cc', 'Buscopan', 'Diasgest', 'M.car', 'ORS', 'Paracetamol(500)', 'Motilium', 'K-milk', '‡∏¢‡∏≤‡∏´‡∏≠‡∏°', 'CA-R-Bon'],
        muscle: ['Balm', 'Mydoclam', 'Norgesic'],
        brain: ['B1,6,12', 'Dimen', 'ORS', 'Paracetamol(500)'],
        skin: ['Acyclovir', 'CPM', 'Loratadine', 'Zyetec', '0.1%TA Cream', 'Mycozol', 'Silver cream', 'Calamine lotion'],
        medicine: [],
        urinary: ['Paracetamol(500)', 'Norflox'],
        reproductive: ['Ponstan(500)'],
        eye: ['Hista oph', 'Op Sar', 'Ointment', 'Brufen(400)', 'Kenalog'],
        throat: [],
        nose: [],
        wound: ['Plaster', '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ'],
        work_accident: [],
        nonwork_accident: [],
        supply: [
          '‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏ô‡∏™‡∏≥‡∏•‡∏µ', 'EB:3', 'EB:2', 'Mask', 'Grove Dispose', 'Eyepad',
          'Transpore', 'Sofatulle', '‡πÑ‡∏°‡πâ‡∏Å‡∏î‡∏•‡∏¥‡πâ‡∏ô', 'Gouze', 'Betadine',
          '70%Alcohol', '0.9%NSS', 'Amora'
        ],
        other: []
      };

      edit_symptom_group.addEventListener("change", () => {
        medSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
        lotSelect.innerHTML = '<option value="">Lot</option>';
        medSelect.style.display = 'block';
        medOther.style.display = 'none';

        if (edit_symptom_group.value === 'other') {
          medSelect.style.display = 'none';
          medOther.style.display = 'block';
          return;
        }

        (medicineData[edit_symptom_group.value] || []).forEach(item => {
          const opt = document.createElement("option");
          opt.value = item;
          opt.textContent = item;
          medSelect.appendChild(opt);
        });
      });

      medSelect.addEventListener("change", async () => {
        lotSelect.innerHTML = '<option value="">Lot</option>';
        if (!medSelect.value) return;

        try {
          const resId = await fetch(`/api/medicine_id?name=${encodeURIComponent(medSelect.value)}`, { cache: "no-store" });
          const dataId = await resId.json();
          const medId = dataId.medicine_id;

          if (!medId) {
            console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö medicine_id:", medSelect.value);
            return;
          }

          const resLots = await fetch(`/api/medicine_lots?medicine_id=${medId}`, { cache: "no-store" });
          const dataLots = await resLots.json();

          (dataLots.lots || []).forEach(lot => {
            const opt = document.createElement("option");
            opt.value = lot.id;
            opt.textContent = `${lot.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${lot.remain})`;
            opt.dataset.price = lot.price || 0;
            lotSelect.appendChild(opt);
          });

        } catch (err) {
          console.error(err);
          alert("‡πÇ‡∏´‡∏•‡∏î Lot ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      });

      function addMedicine() {
        const name = medSelect.value || medOther.value;
        const lotText = lotSelect.options[lotSelect.selectedIndex]?.text || "";
        const lotId = lotSelect.value;
        const qty = parseInt(qtyInput.value, 10);

        if (!name || !lotId || !qty) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
          return;
        }

        editMedicines.push({
          name: name,
          lot: lotText,
          lot_id: lotId,
          qty: qty,
          price: lotSelect.options[lotSelect.selectedIndex].dataset.price || "-"
        });

        renderMedicineTable();
        qtyInput.value = "";
        lotSelect.innerHTML = '<option value="">Lot</option>';
      }

      /* ===============================
         SUBMIT EDIT
      ================================ */
      document.getElementById("editForm").addEventListener("submit", e => {
        e.preventDefault();

        fetch(`/api/treatment/edit/${edit_id.value}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          cache: "no-store",
          body: JSON.stringify({
            visit_date: edit_date.value,
            patient_name: edit_name.value,
            department: edit_department.value,
            symptom_group: edit_symptom_group.value,
            symptom_detail: edit_symptom.value,
            medicine: JSON.stringify(editMedicines),
            allergy: document.querySelector('input[name="allergy"]:checked').value,
            allergy_detail: edit_allergy_detail.value,
            occupational_disease: document.querySelector('input[name="occupational_disease"]:checked').value,
            doctor_opinion: edit_doctor_opinion.value
          })
        })
          .then(res => res.json())
          .then(async r => {
            if (!r.success) {
              alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
              return;
            }
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            await loadRecords();
            switchPage("page-list");
          });
      });
    </script>

    <!-- ===== FOOTER ===== -->
    <div class="footer">
      ¬© 2026 Safety Officer, CPF Khon Kaen Feedmill
    </div>

    <div id="toast" class="toast"></div>
</body>

</html>
