<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f6f8;
      margin: 0;
      font-size: 24px;
    }

    /* ================= HEADER ================= */
    .header {
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #5b2c83;
    }
    .header-left i { font-size: 26px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .logout-btn {
      background: #ff6b6b;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }

    /* ===== container ===== */
    .container {
      max-width: 1500px;
      background: #ffffff;
      margin: 40px auto;
      padding: 40px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      position: relative;
    }

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π) ===== */
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      margin-bottom:20px;
    }

    .back-menu-btn{
      display:inline-block;
      background:#28a745;
      color:white;
      padding:10px 20px;
      font-size:20px;
      border-radius:8px;
      text-decoration:none;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      transition:0.2s;
    }
    .back-menu-btn:hover{ background:#218838; }

    h2 {
      text-align: center;
      margin: 10px 0 25px;
      font-size: 32px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 12px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: #d6ecff;
      font-weight: 600;
    }

    .action-btn {
      margin: 0 6px;
      font-size: 22px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 10px;
      user-select: none;
    }
    .action-btn:hover { opacity: 0.75; }

    .action-btn.danger { filter: saturate(1.2); }
    .action-btn.disabled {
      pointer-events: none;
      opacity: .55;
    }

    /* ‚úÖ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡∏•‡∏ö */
    tr.removing{
      opacity: .45;
      filter: grayscale(1);
    }

    /* ‚úÖ Toast ‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI */
    .toast{
      position: fixed;
      right: 24px;
      bottom: 24px;
      z-index: 9999;
      background: #333;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 18px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      max-width: min(520px, calc(100vw - 48px));
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast.success{ background:#1b7f3a; }
    .toast.error{ background:#b3261e; }
    .toast.info{ background:#2a2a2a; }

    /* ================= FOOTER ================= */
    .footer {
      width: 100%;
      background: #dcdcdc;
      text-align: center;
      padding: 18px;
      font-size: 14px;
      color: #555;
      margin-top: 60px;
    }
  </style>
</head>

<body>

  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <i class="fa-solid fa-stethoscope"></i>
      ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• CPF ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
    </div>

    <div class="header-right">
      {{ session.get('user_name', 'User') }} ({{ session.get('role', 'user') }}) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô Safety
      <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å</a>
    </div>
  </div>

  <div class="container">

    <div class="top-bar">
      <a href="/waste" class="back-menu-btn">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
    </div>

    <h2>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏¢‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</h2>

    <table id="wasteTable">
      <thead>
        <tr>
          <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏£‡∏π‡∏õ</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>

      <tbody id="wasteTbody">
        {% if records|length == 0 %}
        <tr class="row-empty">
          <td colspan="5" style="color:#777;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
        {% else %}
        {% for w in records %}
        <tr data-id="{{ w.id }}">
          <td class="col-no">{{ loop.index }}</td>
          <td>{{ w.date }}</td>
          <td>
            {% if w.photo %}
            <img src="{{ w.photo }}" style="max-width:120px;border-radius:8px;">
            {% else %}
            <span style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>
            {% endif %}
          </td>
          <td>{{ w.place }}</td>
          <td>
            <a href="/waste/view/{{ w.id }}" class="action-btn" title="‡∏î‡∏π">üëÅÔ∏è</a>
            <a href="/waste/edit/{{ w.id }}" class="action-btn" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</a>

            <!-- ‚úÖ ‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß: ‡∏¢‡∏±‡∏á‡∏°‡∏µ href ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ JS ‡∏õ‡∏¥‡∏î) ‡πÅ‡∏ï‡πà JS ‡∏à‡∏∞ intercept -->
            <a href="/waste/delete/{{ w.id }}"
               class="action-btn danger js-delete"
               data-id="{{ w.id }}"
               title="‡∏•‡∏ö">üóëÔ∏è</a>
          </td>
        </tr>
        {% endfor %}
        {% endif %}
      </tbody>
    </table>

  </div>

  <div class="footer">
    ¬© 2026 Safety Officer, CPF Khon Kaen Feedmill
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const deletingIds = new Set();

    function showToast(msg, type="info", ms=1400){
      const el = document.getElementById("toast");
      if (!el) return;
      el.className = `toast ${type}`;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => el.classList.remove("show"), ms);
    }

    function renumberRows(){
      const rows = document.querySelectorAll("#wasteTbody tr[data-id]");
      rows.forEach((tr, idx) => {
        const no = tr.querySelector(".col-no");
        if (no) no.textContent = String(idx + 1);
      });
    }

    function ensureEmptyRow(){
      const tbody = document.getElementById("wasteTbody");
      const hasData = tbody.querySelector('tr[data-id]');
      let empty = tbody.querySelector('.row-empty');

      if (!hasData && !empty){
        tbody.insertAdjacentHTML("beforeend", `
          <tr class="row-empty">
            <td colspan="5" style="color:#777;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        `);
      }

      if (hasData && empty){
        empty.remove();
      }
    }

    // ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload ‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‚Äú‡πÅ‡∏ñ‡∏ß‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‚Äù
    async function deleteWaste(id, btn){
      if (deletingIds.has(id)) return;
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")) return;

      deletingIds.add(id);

      const row = btn.closest("tr");
      const parent = row ? row.parentNode : null;
      const nextEl = row ? row.nextElementSibling : null;
      const rowHTML = row ? row.outerHTML : null;

      // --- Optimistic UI: ‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
      if (row){
        row.classList.add("removing");
        // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
        row.querySelectorAll(".action-btn").forEach(a => a.classList.add("disabled"));
        btn.textContent = "‚è≥";
        btn.title = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...";
        // ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà rebuild ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
        row.remove();
        renumberRows();
        ensureEmptyRow();
      }

      showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...", "info", 900);

      // --- ‡∏¢‡∏¥‡∏á backend ‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á ---
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 12000); // ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á 12s

      try{
        // ‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏î‡∏¥‡∏° /waste/delete/<id> (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô GET ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß redirect)
        const url = btn.getAttribute("href");

        const res = await fetch(url, {
          method: "GET",
          cache: "no-store",
          redirect: "follow",
          keepalive: true,
          signal: controller.signal
        });

        clearTimeout(timer);

        if (!res.ok) throw new Error("delete failed");

        showToast("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "success", 1400);

      }catch(err){
        clearTimeout(timer);
        console.error(err);

        // rollback: ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Å‡∏•‡∏±‡∏ö
        if (parent && rowHTML){
          // ‡∏•‡∏ö empty row ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          const empty = document.querySelector("#wasteTbody .row-empty");
          if (empty) empty.remove();

          if (nextEl) nextEl.insertAdjacentHTML("beforebegin", rowHTML);
          else parent.insertAdjacentHTML("beforeend", rowHTML);

          renumberRows();
          ensureEmptyRow();
        }

        showToast("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß)", "error", 2200);
      }finally{
        deletingIds.delete(id);
      }
    }

    // ‚úÖ ‡πÉ‡∏ä‡πâ event delegation: ‡πÄ‡∏£‡πá‡∏ß + ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å onclick ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById("wasteTbody");
      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest(".js-delete");
        if (!btn) return;
        e.preventDefault();
        const id = btn.dataset.id;
        deleteWaste(id, btn);
      });
    });
  </script>

</body>
</html>
